<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Federation API</title>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    border-left: 5px solid;
    padding-left: 20px;
}

</style>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/*
*   math2html: convert LaTeX equations to HTML output.
*
*   Copyright (C) 2009,2010 Alex Fernández
*
*   Released under the terms of the `2-Clause BSD license'_, in short:
*   Copying and distribution of this file, with or without modification,
*   are permitted in any medium without royalty provided the copyright
*   notice and this notice are preserved.
*   This file is offered as-is, without any warranty.
*
* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause
*
*   Based on eLyXer: convert LyX source files to HTML output.
*   http://elyxer.nongnu.org/
*/
/* --end--
* CSS file for LaTeX formulas.
*/

/* Formulas */
.formula {
	text-align: center;
	font-family: "Droid Serif", "DejaVu Serif", "STIX", serif;
	margin: 1.2em 0;
}
span.formula {
	white-space: nowrap;
}
div.formula {
	padding: 0.5ex;
	margin-left: auto;
	margin-right: auto;
}

/* Basic features */
a.eqnumber {
	display: inline-block;
	float: right;
	clear: right;
	font-weight: bold;
}
span.unknown {
	color: #800000;
}
span.ignored, span.arraydef {
	display: none;
}
.formula i {
	letter-spacing: 0.1ex;
}

/* Alignment */
.align-left, .align-l {
	text-align: left;
}
.align-right, .align-r {
	text-align: right;
}
.align-center, .align-c {
	text-align: center;
}

/* Structures */
span.overline, span.bar {
	text-decoration: overline;
}
.fraction, .fullfraction {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
}
.fraction .fraction {
	font-size: 80%;
	line-height: 100%;
}
span.numerator {
	display: block;
}
span.denominator {
	display: block;
	padding: 0ex;
	border-top: thin solid;
}
sup.numerator, sup.unit {
	font-size: 70%;
	vertical-align: 80%;
}
sub.denominator, sub.unit {
	font-size: 70%;
	vertical-align: -20%;
}
span.sqrt {
	display: inline-block;
	vertical-align: middle;
	padding: 0.1ex;
}
sup.root {
	font-size: 70%;
	position: relative;
	left: 1.4ex;
}
span.radical {
	display: inline-block;
	padding: 0ex;
	font-size: 150%;
	vertical-align: top;
}
span.root {
	display: inline-block;
	border-top: thin solid;
	padding: 0ex;
	vertical-align: middle;
}
span.symbol {
	line-height: 125%;
	font-size: 125%;
}
span.bigsymbol {
	line-height: 150%;
	font-size: 150%;
}
span.largesymbol {
	font-size: 175%;
}
span.hugesymbol {
	font-size: 200%;
}
span.scripts {
	display: inline-table;
	vertical-align: middle;
}
.script {
	display: table-row;
	text-align: left;
	line-height: 150%;
}
span.limits {
	display: inline-table;
	vertical-align: middle;
}
.limit {
	display: table-row;
	line-height: 99%;
}
sup.limit, sub.limit {
	line-height: 100%;
}
span.symbolover {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 100%;
	bottom: 0.5em;
	width: 0px;
}
span.withsymbol {
	display: inline-block;
}
span.symbolunder {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 80%;
	top: 0.3em;
	width: 0px;
}

/* Environments */
span.array, span.bracketcases, span.binomial, span.environment {
	display: inline-table;
	text-align: center;
	border-collapse: collapse;
	margin: 0em;
	vertical-align: middle;
}
span.arrayrow, span.binomrow {
	display: table-row;
	padding: 0ex;
	border: 0ex;
}
span.arraycell, span.bracket, span.case, span.binomcell, span.environmentcell {
	display: table-cell;
	padding: 0ex 0.2ex;
	line-height: 99%;
	border: 0ex;
}
/*
* CSS file for LaTeX formulas, extra stuff:
* binomials, vertical braces, stackrel, fonts and colors.
*/

/* Inline binomials */
span.binom {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
	font-size: 80%;
}
span.binomstack {
	display: block;
	padding: 0em;
}

/* Over- and underbraces */
span.overbrace {
	border-top: 2pt solid;
}
span.underbrace {
	border-bottom: 2pt solid;
}

/* Stackrel */
span.stackrel {
	display: inline-block;
	text-align: center;
}
span.upstackrel {
	display: block;
	padding: 0em;
	font-size: 80%;
	line-height: 64%;
	position: relative;
	top: 0.15em;

}
span.downstackrel {
	display: block;
	vertical-align: bottom;
	padding: 0em;
}

/* Fonts */
span.mathsf, span.textsf {
	font-style: normal;
	font-family: sans-serif;
}
span.mathrm, span.textrm {
	font-style: normal;
	font-family: serif;
}
span.text, span.textnormal {
	font-style: normal;
}
span.textipa {
	color: #008080;
}
span.fraktur {
	font-family: "Lucida Blackletter", eufm10, blackletter;
}
span.blackboard {
	font-family: Blackboard, msbm10, serif;
}
span.scriptfont {
	font-family: "Monotype Corsiva", "Apple Chancery", "URW Chancery L", cursive;
	font-style: italic;
}

/* Colors */
span.colorbox {
	display: inline-block;
	padding: 5px;
}
span.fbox {
	display: inline-block;
	border: thin solid black;
	padding: 2px;
}
span.boxed, span.framebox {
	display: inline-block;
	border: thin solid black;
	padding: 5px;
}


</style>
</head>
<body>
<div class="document" id="federation-api">
<h1 class="title">Federation API</h1>

<!-- Copyright 2016 OpenMarket Ltd -->
<!-- Copyright 2017 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>Matrix homeservers use the Federation APIs (also known as server-server APIs)
to communicate with each other. Homeservers use these APIs to push messages to
each other in real-time, to
historic messages from each other, and to
query profile and presence information about users on each other's servers.</p>
<p>The APIs are implemented using HTTPS GETs and PUTs between each of the
servers. These HTTPS requests are strongly authenticated using public key
signatures at the TLS transport layer and using public key signatures in
HTTP Authorization headers at the HTTP layer.</p>
<p>There are three main kinds of communication that occur between homeservers:</p>
<dl class="docutils">
<dt>Persisted Data Units (PDUs):</dt>
<dd><p class="first">These events are broadcast from one homeserver to any others that have
joined the same room (identified by Room ID). They are persisted in
long-term storage and record the history of messages and state for a
room.</p>
<p class="last">Like email, it is the responsibility of the originating server of a PDU
to deliver that event to its recipient servers. However PDUs are signed
using the originating server's private key so that it is possible to
deliver them through third-party servers.</p>
</dd>
<dt>Ephemeral Data Units (EDUs):</dt>
<dd>These events are pushed between pairs of homeservers. They are not
persisted and are not part of the history of a room, nor does the
receiving homeserver have to reply to them.</dd>
<dt>Queries:</dt>
<dd>These are single request/response interactions between a given pair of
servers, initiated by one side sending an HTTPS GET request to obtain some
information, and responded by the other. They are not persisted and contain
no long-term significant history. They simply request a snapshot state at
the instant the query is made.</dd>
</dl>
<p>EDUs and PDUs are further wrapped in an envelope called a Transaction, which is
transferred from the origin to the destination homeserver using an HTTPS PUT
request.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#specification-version" id="id2">1&nbsp;&nbsp;&nbsp;Specification version</a></li>
<li><a class="reference internal" href="#server-discovery" id="id3">2&nbsp;&nbsp;&nbsp;Server Discovery</a><ul class="auto-toc">
<li><a class="reference internal" href="#resolving-server-names" id="id4">2.1&nbsp;&nbsp;&nbsp;Resolving Server Names</a></li>
<li><a class="reference internal" href="#server-implementation" id="id5">2.2&nbsp;&nbsp;&nbsp;Server implementation</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-version" id="id6">2.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/version</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#retrieving-server-keys" id="id7">2.3&nbsp;&nbsp;&nbsp;Retrieving Server Keys</a><ul class="auto-toc">
<li><a class="reference internal" href="#version-2" id="id8">2.3.1&nbsp;&nbsp;&nbsp;Version 2</a><ul class="auto-toc">
<li><a class="reference internal" href="#publishing-keys" id="id9">2.3.1.1&nbsp;&nbsp;&nbsp;Publishing Keys</a></li>
<li><a class="reference internal" href="#querying-keys-through-another-server" id="id10">2.3.1.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#version-1" id="id11">2.3.2&nbsp;&nbsp;&nbsp;Version 1</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#transactions" id="id12">3&nbsp;&nbsp;&nbsp;Transactions</a><ul class="auto-toc">
<li><a class="reference internal" href="#transaction-fields" id="id13">3.1&nbsp;&nbsp;&nbsp;Transaction Fields</a></li>
</ul>
</li>
<li><a class="reference internal" href="#pdus" id="id14">4&nbsp;&nbsp;&nbsp;PDUs</a><ul class="auto-toc">
<li><a class="reference internal" href="#pdu-fields" id="id15">4.1&nbsp;&nbsp;&nbsp;PDU Fields</a></li>
<li><a class="reference internal" href="#authorization-of-pdus" id="id16">4.2&nbsp;&nbsp;&nbsp;Authorization of PDUs</a><ul class="auto-toc">
<li><a class="reference internal" href="#definitions" id="id17">4.2.1&nbsp;&nbsp;&nbsp;Definitions</a></li>
<li><a class="reference internal" href="#rules" id="id18">4.2.2&nbsp;&nbsp;&nbsp;Rules</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#edus" id="id19">5&nbsp;&nbsp;&nbsp;EDUs</a></li>
<li><a class="reference internal" href="#room-state-resolution" id="id20">6&nbsp;&nbsp;&nbsp;Room State Resolution</a><ul class="auto-toc">
<li><a class="reference internal" href="#state-resolution-algorithm" id="id21">6.1&nbsp;&nbsp;&nbsp;State resolution algorithm</a></li>
</ul>
</li>
<li><a class="reference internal" href="#protocol-urls" id="id22">7&nbsp;&nbsp;&nbsp;Protocol URLs</a></li>
<li><a class="reference internal" href="#joining-rooms" id="id23">8&nbsp;&nbsp;&nbsp;Joining Rooms</a></li>
<li><a class="reference internal" href="#backfilling" id="id24">9&nbsp;&nbsp;&nbsp;Backfilling</a></li>
<li><a class="reference internal" href="#inviting-to-a-room" id="id25">10&nbsp;&nbsp;&nbsp;Inviting to a room</a></li>
<li><a class="reference internal" href="#third-party-invites" id="id26">11&nbsp;&nbsp;&nbsp;Third-party invites</a><ul class="auto-toc">
<li><a class="reference internal" href="#cases-where-an-association-exists-for-a-third-party-identifier" id="id27">11.1&nbsp;&nbsp;&nbsp;Cases where an association exists for a third-party identifier</a></li>
<li><a class="reference internal" href="#cases-where-an-association-doesn-t-exist-for-a-third-party-identifier" id="id28">11.2&nbsp;&nbsp;&nbsp;Cases where an association doesn't exist for a third-party identifier</a><ul class="auto-toc">
<li><a class="reference internal" href="#verifying-the-invite" id="id29">11.2.1&nbsp;&nbsp;&nbsp;Verifying the invite</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#authentication" id="id30">12&nbsp;&nbsp;&nbsp;Authentication</a><ul class="auto-toc">
<li><a class="reference internal" href="#request-authentication" id="id31">12.1&nbsp;&nbsp;&nbsp;Request Authentication</a></li>
<li><a class="reference internal" href="#response-authentication" id="id32">12.2&nbsp;&nbsp;&nbsp;Response Authentication</a></li>
<li><a class="reference internal" href="#client-tls-certificates" id="id33">12.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></li>
</ul>
</li>
<li><a class="reference internal" href="#presence" id="id34">13&nbsp;&nbsp;&nbsp;Presence</a></li>
<li><a class="reference internal" href="#profiles" id="id35">14&nbsp;&nbsp;&nbsp;Profiles</a></li>
<li><a class="reference internal" href="#directory" id="id36">15&nbsp;&nbsp;&nbsp;Directory</a><ul class="auto-toc">
<li><a class="reference internal" href="#get-matrix-federation-v1-query-directory" id="id37">15.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/directory</tt></a></li>
</ul>
</li>
<li><a class="reference internal" href="#send-to-device-messaging" id="id38">16&nbsp;&nbsp;&nbsp;Send-to-device messaging</a></li>
<li><a class="reference internal" href="#signing-events" id="id39">17&nbsp;&nbsp;&nbsp;Signing Events</a></li>
</ul>
</div>
<p><a class="anchor" id="specification-version"></a></p>
<div class="section" id="specification-version">
<h1><a class="toc-backref" href="#id2">1&nbsp;&nbsp;&nbsp;Specification version</a></h1>
<p>This version of the specification is generated from
<a class="reference external" href="https://github.com/matrix-org/matrix-doc">matrix-doc</a> as of Git commit
<a class="reference external" href="https://github.com/matrix-org/matrix-doc/tree/5e1c735">master,5e1c735</a>.</p>
</div>
<p><a class="anchor" id="server-discovery"></a></p>
<div class="section" id="server-discovery">
<h1><a class="toc-backref" href="#id3">2&nbsp;&nbsp;&nbsp;Server Discovery</a></h1>
<p><a class="anchor" id="resolving-server-names"></a></p>
<div class="section" id="resolving-server-names">
<h2><a class="toc-backref" href="#id4">2.1&nbsp;&nbsp;&nbsp;Resolving Server Names</a></h2>
<p>Each matrix homeserver is identified by a server name consisting of a DNS name
and an optional TLS port.</p>
<pre class="code literal-block">
server_name = dns_name [ &quot;:&quot; tls_port]
dns_name = &lt;host, see [RFC 3986], Section 3.2.2&gt;
tls_port = *DIGIT
</pre>
<!-- ** -->
<p>If the port is present then the server is discovered by looking up an AAAA or
A record for the DNS name and connecting to the specified TLS port. If the port
is absent then the server is discovered by looking up a <tt class="docutils literal">_matrix._tcp</tt> SRV
record for the DNS name. If this record does not exist then the server is
discovered by looking up an AAAA or A record on the DNS name and taking the
default fallback port number of 8448.
Homeservers may use SRV records to load balance requests between multiple TLS
endpoints or to failover to another endpoint if an endpoint fails.</p>
</div>
<p><a class="anchor" id="server-implementation"></a></p>
<div class="section" id="server-implementation">
<h2><a class="toc-backref" href="#id5">2.2&nbsp;&nbsp;&nbsp;Server implementation</a></h2>
<p><a class="anchor" id="get-matrix-federation-v1-version"></a></p>
<div class="section" id="get-matrix-federation-v1-version">
<h3><a class="toc-backref" href="#id6">2.2.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/version</tt></a></h3>
<p>Get the implementation name and version of this homeserver.</p>
<p>Request format:</p>
<p><cite>No parameters</cite></p>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>server</td>
<td>Server</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Server</tt></p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>name</td>
<td>string</td>
<td>Arbitrary name that identify this implementation.</td>
</tr>
<tr><td>version</td>
<td>string</td>
<td>Version of this implementation. The version format
depends on the implementation.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/federation/v1/version</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The implementation name and version of this homeserver.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;server&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
    <span class="name tag">&quot;name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;My_Homeserver_Implementation&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;version&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ArbitraryVersionNumber&quot;</span>
  <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="retrieving-server-keys"></a></p>
<div class="section" id="retrieving-server-keys">
<h2><a class="toc-backref" href="#id7">2.3&nbsp;&nbsp;&nbsp;Retrieving Server Keys</a></h2>
<p><a class="anchor" id="version-2"></a></p>
<div class="section" id="version-2">
<h3><a class="toc-backref" href="#id8">2.3.1&nbsp;&nbsp;&nbsp;Version 2</a></h3>
<p>Each homeserver publishes its public keys under <tt class="docutils literal">/_matrix/key/v2/server/</tt>.
Homeservers query for keys by either getting <tt class="docutils literal">/_matrix/key/v2/server/</tt>
directly or by querying an intermediate notary server using a
<tt class="docutils literal">/_matrix/key/v2/query</tt> API. Intermediate notary servers query the
<tt class="docutils literal">/_matrix/key/v2/server/</tt> API on behalf of another server and sign the
response with their own key. A server may query multiple notary servers to
ensure that they all report the same public keys.</p>
<p>This approach is borrowed from the <a class="reference external" href="https://web.archive.org/web/20170702024706/https://perspectives-project.org/">Perspectives Project</a>, but modified to
include the NACL keys and to use JSON instead of XML. It has the advantage of
avoiding a single trust-root since each server is free to pick which notary
servers they trust and can corroborate the keys returned by a given notary
server by querying other servers.</p>
<p><a class="anchor" id="publishing-keys"></a></p>
<div class="section" id="publishing-keys">
<h4><a class="toc-backref" href="#id9">2.3.1.1&nbsp;&nbsp;&nbsp;Publishing Keys</a></h4>
<p>Homeservers publish the allowed TLS fingerprints and signing keys in a JSON
object at <tt class="docutils literal"><span class="pre">/_matrix/key/v2/server/{key_id}</span></tt>. The response contains a list of
<tt class="docutils literal">verify_keys</tt> that are valid for signing federation requests made by the
server and for signing events. It contains a list of <tt class="docutils literal">old_verify_keys</tt>
which are only valid for signing events. Finally the response contains a list
of TLS certificate fingerprints to validate any connection made to the server.</p>
<p>A server may have multiple keys active at a given time. A server may have any
number of old keys. It is recommended that servers return a single JSON
response listing all of its keys whenever any <tt class="docutils literal">key_id</tt> is requested to reduce
the number of round trips needed to discover the relevant keys for a server.
However a server may return a different responses for a different <tt class="docutils literal">key_id</tt>.</p>
<p>The <tt class="docutils literal">tls_certificates</tt> contain a list of hashes of the X.509 TLS certificates
currently used by the server. The list must include SHA-256 hashes for every
certificate currently in use by the server. These fingerprints are valid until
the millisecond POSIX timestamp in <tt class="docutils literal">valid_until_ts</tt>.</p>
<p>The <tt class="docutils literal">verify_keys</tt> can be used to sign requests and events made by the server
until the millisecond POSIX timestamp in <tt class="docutils literal">valid_until_ts</tt>. If a homeserver
receives an event with a <tt class="docutils literal">origin_server_ts</tt> after the <tt class="docutils literal">valid_until_ts</tt> then
it should request that <tt class="docutils literal">key_id</tt> for the originating server to check whether
the key has expired.</p>
<p>The <tt class="docutils literal">old_verify_keys</tt> can be used to sign events with an <tt class="docutils literal">origin_server_ts</tt>
before the <tt class="docutils literal">expired_ts</tt>. The <tt class="docutils literal">expired_ts</tt> is a millisecond POSIX timestamp
of when the originating server stopped using that key.</p>
<p>Intermediate notary servers should cache a response for half of its remaining
life time to avoid serving a stale response. Originating servers should avoid
returning responses that expire in less than an hour to avoid repeated requests
for an about to expire certificate. Requesting servers should limit how
frequently they query for certificates to avoid flooding a server with requests.</p>
<p>If a server goes offline intermediate notary servers should continue to return
the last response they received from that server so that the signatures of old
events sent by that server can still be checked.</p>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="21%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">server_name</tt></td>
<td>String</td>
<td>DNS name of the homeserver.</td>
</tr>
<tr><td><tt class="docutils literal">verify_keys</tt></td>
<td>Object</td>
<td>Public keys of the homeserver for
verifying digital signatures.</td>
</tr>
<tr><td><tt class="docutils literal">old_verify_keys</tt></td>
<td>Object</td>
<td>The public keys that the server used
to use and when it stopped using them.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>Object</td>
<td>Digital signatures for this object
signed using the <tt class="docutils literal">verify_keys</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">tls_fingerprints</tt></td>
<td>Array of Objects</td>
<td>Hashes of X.509 TLS certificates used
by this this server encoded as <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a>.</td>
</tr>
<tr><td><tt class="docutils literal">valid_until_ts</tt></td>
<td>Integer</td>
<td>POSIX timestamp when the list of valid
keys should be refreshed.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;old_verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto1&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;expired_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">922834800000</span><span class="punctuation">,</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Old+Verify+Key&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:auto2&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;tls_fingerprints&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="punctuation">{</span>
            <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+SHA-256-Fingerprint&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;valid_until_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1052262000000</span><span class="punctuation">,</span>
    <span class="name tag">&quot;verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto2&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature+Verification+Key&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="querying-keys-through-another-server"></a></p>
<div class="section" id="querying-keys-through-another-server">
<h4><a class="toc-backref" href="#id10">2.3.1.2&nbsp;&nbsp;&nbsp;Querying Keys Through Another Server</a></h4>
<p>Servers may offer a query API <tt class="docutils literal">_matrix/key/v2/query/</tt> for getting the keys
for another server. This API can be used to GET at list of JSON objects for a
given server or to POST a bulk query for a number of keys from a number of
servers. Either way the response is a list of JSON objects containing the
JSON published by the server under <tt class="docutils literal">_matrix/key/v2/server/</tt> signed by
both the originating server and by this server.</p>
<p>The <tt class="docutils literal">minimum_valid_until_ts</tt> is a millisecond POSIX timestamp indicating
when the returned certificate will need to be valid until to be useful to the
requesting server. This can be set using the maximum <tt class="docutils literal">origin_server_ts</tt> of
an batch of events that a requesting server is trying to validate. This allows
an intermediate notary server to give a prompt cached response even if the
originating server is offline.</p>
<p>This API can return keys for servers that are offline be using cached responses
taken from when the server was online. Keys can be queried from multiple
servers to mitigate against DNS spoofing.</p>
<p>Requests:</p>
<pre class="code literal-block">
GET /_matrix/key/v2/query/${server_name}/${key_id}/?minimum_valid_until_ts=${minimum_valid_until_ts} HTTP/1.1

POST /_matrix/key/v2/query HTTP/1.1
Content-Type: application/json

{
    &quot;server_keys&quot;: {
        &quot;$server_name&quot;: {
            &quot;$key_id&quot;: {
                &quot;minimum_valid_until_ts&quot;: $posix_timestamp
            }
        }
    }
}
</pre>
<p>Response:</p>
<pre class="code literal-block">
HTTP/1.1 200 OK
Content-Type: application/json
{
    &quot;server_keys&quot;: [
       # List of responses with same format as /_matrix/key/v2/server
       # signed by both the originating server and this server.
    ]
}
</pre>
</div>
</div>
<p><a class="anchor" id="version-1"></a></p>
<div class="section" id="version-1">
<h3><a class="toc-backref" href="#id11">2.3.2&nbsp;&nbsp;&nbsp;Version 1</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Version 1 of key distribution is obsolete</p>
</div>
<p>Homeservers publish their TLS certificates and signing keys in a JSON object
at <tt class="docutils literal">/_matrix/key/v1</tt>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="23%" />
<col width="52%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">server_name</tt></td>
<td>String</td>
<td>DNS name of the homeserver.</td>
</tr>
<tr><td><tt class="docutils literal">verify_keys</tt></td>
<td>Object</td>
<td>Public keys of the homeserver for
verifying digital signatures.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>Object</td>
<td>Digital signatures for this object
signed using the <tt class="docutils literal">verify_keys</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">tls_certificate</tt></td>
<td>String</td>
<td>The X.509 TLS certificate used by this
this server encoded as <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a>.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;server_name&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example.org&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:auto&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;tls_certificate&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+DER+Encoded+X509+TLS+Certificate&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;verify_keys&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;ed25519:auto&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;Base+64+Encoded+Signature+Verification+Key&quot;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>When fetching the keys for a server the client should check that the TLS
certificate in the JSON matches the TLS server certificate for the connection
and should check that the JSON signatures are correct for the supplied
<tt class="docutils literal">verify_keys</tt></p>
</div>
</div>
</div>
<p><a class="anchor" id="transactions"></a></p>
<div class="section" id="transactions">
<h1><a class="toc-backref" href="#id12">3&nbsp;&nbsp;&nbsp;Transactions</a></h1>
<p>The transfer of EDUs and PDUs between homeservers is performed by an exchange
of Transaction messages, which are encoded as JSON objects, passed over an HTTP
PUT request. A Transaction is meaningful only to the pair of homeservers that
exchanged it; they are not globally-meaningful.</p>
<dl class="docutils">
<dt>Each transaction has:</dt>
<dd><ul class="first last simple">
<li>An opaque transaction ID, unique among transactions from the same origin.</li>
<li>A timestamp (UNIX epoch time in milliseconds) generated by its origin
server.</li>
<li>An origin and destination server name.</li>
<li>A list of PDUs and EDUs - the actual message payload that the Transaction
carries.</li>
</ul>
</dd>
</dl>
<p><a class="anchor" id="transaction-fields"></a></p>
<div class="section" id="transaction-fields">
<h2><a class="toc-backref" href="#id13">3.1&nbsp;&nbsp;&nbsp;Transaction Fields</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="21%" />
<col width="57%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td><strong>Required</strong>. <tt class="docutils literal">server_name</tt> of homeserver sending
this transaction.</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td><strong>Required</strong>. Timestamp in milliseconds on
originating homeserver when this
transaction started.</td>
</tr>
<tr><td><tt class="docutils literal">pdus</tt></td>
<td>List of Objects</td>
<td><strong>Required</strong>. List of persistent updates to rooms.</td>
</tr>
<tr><td><tt class="docutils literal">edus</tt></td>
<td>List of Objects</td>
<td>List of ephemeral messages. May be omitted
if there are no ephemeral messages to
be sent.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span><span class="literal number integer">1404835423000</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;pdus&quot;</span><span class="punctuation">:[</span><span class="error">...</span><span class="punctuation">],</span>
 <span class="name tag">&quot;edus&quot;</span><span class="punctuation">:[</span><span class="error">...</span><span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="pdus"></a></p>
<div class="section" id="pdus">
<h1><a class="toc-backref" href="#id14">4&nbsp;&nbsp;&nbsp;PDUs</a></h1>
<p>Each PDU contains a single Room Event which the origin server wants to send to
the destination.</p>
<p><a class="anchor" id="pdu-fields"></a></p>
<div class="section" id="pdu-fields">
<h2><a class="toc-backref" href="#id15">4.1&nbsp;&nbsp;&nbsp;PDU Fields</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="23%" />
<col width="51%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">room_id</tt></td>
<td>String</td>
<td><strong>Required</strong>. Room identifier.</td>
</tr>
<tr><td><tt class="docutils literal">sender</tt></td>
<td>String</td>
<td><strong>Required</strong>. The ID of the user sending
the event.</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td><strong>Required</strong>. <tt class="docutils literal">server_name</tt> of the
homeserver that created this event.</td>
</tr>
<tr><td><tt class="docutils literal">event_id</tt></td>
<td>String</td>
<td><strong>Required</strong>. Unique identifier for the
event being sent.</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td><strong>Required</strong>. Timestamp in milliseconds
on origin homeserver when this event
was created.</td>
</tr>
<tr><td><tt class="docutils literal">type</tt></td>
<td>String</td>
<td><strong>Required</strong>. Event type</td>
</tr>
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>Optional. If this key is present, the
event is a state event, and it will
replace previous events with the same
<tt class="docutils literal">type</tt> and <tt class="docutils literal">state_key</tt> in the room
state.</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td><strong>Required</strong>. The content of the event.</td>
</tr>
<tr><td><tt class="docutils literal">prev_events</tt></td>
<td>List of (String,
{String: String})
pairs</td>
<td><strong>Required</strong>. Event IDs and hashes of
the most recent events in the room that
the homeserver was aware of when it
made this event</td>
</tr>
<tr><td><tt class="docutils literal">depth</tt></td>
<td>Integer</td>
<td><strong>Required</strong>. The maximum depth of the
<tt class="docutils literal">prev_events</tt>, plus one</td>
</tr>
<tr><td><tt class="docutils literal">auth_events</tt></td>
<td>List of (String,
{String: String})
pairs</td>
<td><strong>Required</strong>. Event IDs and hashes for
the &quot;auth events&quot; of this event.</td>
</tr>
<tr><td><tt class="docutils literal">hashes</tt></td>
<td>{String: String}</td>
<td><strong>Required</strong>. Hashes of the PDU,
following the algorithm specified in
<a class="reference internal" href="#signing-events">Signing Events</a>.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>{String:
{String: String}}</td>
<td><strong>Required</strong>. Signatures of the redacted
PDU, following the algorithm specified
in <a class="reference internal" href="#signing-events">Signing Events</a>.</td>
</tr>
<tr><td><tt class="docutils literal">redacts</tt></td>
<td>String</td>
<td>Optional. For redaction events, the ID
of the event being redacted</td>
</tr>
<tr><td><tt class="docutils literal">unsigned</tt></td>
<td>Object</td>
<td>Optional. Additional data added by the
origin server but not covered by the
<tt class="docutils literal">signatures</tt>.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!UcYsUzyxTGDxLBEvLy:example.org&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;alice:example.com&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;example.com&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;event_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$a4ecee13e2accdadf56c1025:example.com&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1404838188000</span><span class="punctuation">,</span>
 <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;prev_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
   <span class="punctuation">[</span><span class="literal string double">&quot;$af232176:example.org&quot;</span><span class="punctuation">,</span> <span class="punctuation">{</span><span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;abase64encodedsha256hashshouldbe43byteslong&quot;</span><span class="punctuation">}]</span>
 <span class="punctuation">],</span>
 <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;thishashcoversallfieldsincasethisisredacted&quot;</span><span class="punctuation">},</span>
 <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
   <span class="name tag">&quot;example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
     <span class="name tag">&quot;ed25519:key_version:&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;these86bytesofbase64signaturecoveressentialfieldsincludinghashessocancheckredactedpdus&quot;</span>
   <span class="punctuation">}</span>
 <span class="punctuation">},</span>
 <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span><span class="error">...</span><span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
<p>The <tt class="docutils literal">prev_events</tt> field of a PDU identifies the &quot;parents&quot; of the event, and
thus establishes a partial ordering on events within the room by linking them
into a Directed Acyclic Graph (DAG). The sending server should populate this
field with all of the events in the room for which it has not yet seen a
child - thus demonstrating that the event comes after all other known events.</p>
<p>For example, consider a room whose events form the DAG shown below. A server
creating a new event in this room should populate the new event's
<tt class="docutils literal">prev_events</tt> field with <tt class="docutils literal">E4</tt> and <tt class="docutils literal">E5</tt>, since neither event yet has a child:</p>
<pre class="literal-block">
    E1
    ^
    |
+-&gt; E2 &lt;-+
|        |
E3       E5
^
|
E4
</pre>
<p>The <tt class="docutils literal">auth_events</tt> field of a PDU identifies the set of events which give the
sender permission to send the event. The <tt class="docutils literal">auth_events</tt> for the
<tt class="docutils literal">m.room.create</tt> event in a room is empty; for other events, it should be the
following subset of the room state:</p>
<ul class="simple">
<li>The <tt class="docutils literal">m.room.create</tt> event.</li>
<li>The current <tt class="docutils literal">m.room.power_levels</tt> event, if any.</li>
<li>The current <tt class="docutils literal">m.room.join_rules</tt> event, if any.</li>
<li>The sender's current <tt class="docutils literal">m.room.member</tt> event, if any.</li>
</ul>
</div>
<p><a class="anchor" id="authorization-of-pdus"></a></p>
<div class="section" id="authorization-of-pdus">
<h2><a class="toc-backref" href="#id16">4.2&nbsp;&nbsp;&nbsp;Authorization of PDUs</a></h2>
<p>Whenever a server receives an event from a remote server, the receiving server
must check that the event is allowed by the authorization rules. These rules
depend on the state of the room at that event.</p>
<p><a class="anchor" id="definitions"></a></p>
<div class="section" id="definitions">
<h3><a class="toc-backref" href="#id17">4.2.1&nbsp;&nbsp;&nbsp;Definitions</a></h3>
<dl class="docutils">
<dt>Required Power Level</dt>
<dd>A given event type has an associated <em>required power level</em>. This is given by
the current <tt class="docutils literal">m.room.power_levels</tt> event. The event type is either listed
explicitly in the <tt class="docutils literal">events</tt> section or given by either <tt class="docutils literal">state_default</tt> or
<tt class="docutils literal">events_default</tt> depending on if the event is a state event or not.</dd>
<dt>Invite Level, Kick Level, Ban Level, Redact Level</dt>
<dd>The levels given by the <tt class="docutils literal">invite</tt>, <tt class="docutils literal">kick</tt>, <tt class="docutils literal">ban</tt>, and <tt class="docutils literal">redact</tt>
properties in the current <tt class="docutils literal">m.room.power_levels</tt> state. Each defaults to 50
if unspecified.</dd>
<dt>Target User</dt>
<dd>For an <tt class="docutils literal">m.room.member</tt> state event, the user given by the <tt class="docutils literal">state_key</tt> of
the event.</dd>
</dl>
</div>
<p><a class="anchor" id="rules"></a></p>
<div class="section" id="rules">
<span id="authorization-rules"></span><h3><a class="toc-backref" href="#id18">4.2.2&nbsp;&nbsp;&nbsp;Rules</a></h3>
<p>The rules governing whether an event is authorized depend solely on the
state of the room at the point in the room graph at which the new event is to
be inserted. The types of state events that affect authorization are:</p>
<ul class="simple">
<li><tt class="docutils literal">m.room.create</tt></li>
<li><tt class="docutils literal">m.room.member</tt></li>
<li><tt class="docutils literal">m.room.join_rules</tt></li>
<li><tt class="docutils literal">m.room.power_levels</tt></li>
</ul>
<p>Servers should not create new events that reference unauthorized events.
However, any event that does reference an unauthorized event is not itself
automatically considered unauthorized.</p>
<p>Unauthorized events that appear in the event graph do <em>not</em> have any effect on
the state of the room.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is in contrast to redacted events which can still affect the
state of the room. For example, a redacted <tt class="docutils literal">join</tt> event will still
result in the user being considered joined.</p>
</div>
<ol class="arabic simple">
<li>If type is <tt class="docutils literal">m.room.create</tt>, allow if and only if it has no
previous events - <em>i.e.</em> it is the first event in the room.</li>
<li>If type is <tt class="docutils literal">m.room.member</tt>:<ol class="loweralpha">
<li>If <tt class="docutils literal">membership</tt> is <tt class="docutils literal">join</tt>:<ol class="lowerroman">
<li>If the only previous event is an <tt class="docutils literal">m.room.create</tt>
and the <tt class="docutils literal">state_key</tt> is the creator, allow.</li>
<li>If the <tt class="docutils literal">sender</tt> does not match <tt class="docutils literal">state_key</tt>, reject.</li>
<li>If the user's current membership state is <tt class="docutils literal">invite</tt> or <tt class="docutils literal">join</tt>,
allow.</li>
<li>If the <tt class="docutils literal">join_rule</tt> is <tt class="docutils literal">public</tt>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <tt class="docutils literal">membership</tt> is <tt class="docutils literal">invite</tt>:<ol class="lowerroman">
<li>If the <tt class="docutils literal">sender</tt>'s current membership state is not <tt class="docutils literal">join</tt>, reject.</li>
<li>If <em>target user</em>'s current membership state is <tt class="docutils literal">join</tt> or <tt class="docutils literal">ban</tt>,
reject.</li>
<li>If the <tt class="docutils literal">sender</tt>'s power level is greater than or equal to the <em>invite
level</em>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <tt class="docutils literal">membership</tt> is <tt class="docutils literal">leave</tt>:<ol class="lowerroman">
<li>If the <tt class="docutils literal">sender</tt> matches <tt class="docutils literal">state_key</tt>, allow if and only if that user's
current membership state is <tt class="docutils literal">invite</tt> or <tt class="docutils literal">join</tt>.</li>
<li>If the <tt class="docutils literal">sender</tt>'s current membership state is not <tt class="docutils literal">join</tt>, reject.</li>
<li>If the <em>target user</em>'s current membership state is <tt class="docutils literal">ban</tt>, and the
<tt class="docutils literal">sender</tt>'s power level is less than the <em>ban level</em>, reject.</li>
<li>If the <tt class="docutils literal">sender</tt>'s power level is greater than or equal to the <em>kick
level</em>, and the <em>target user</em>'s power level is less than the
<tt class="docutils literal">sender</tt>'s power level, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>If <tt class="docutils literal">membership</tt> is <tt class="docutils literal">ban</tt>:<ol class="lowerroman">
<li>If the <tt class="docutils literal">sender</tt>'s current membership state is not <tt class="docutils literal">join</tt>, reject.</li>
<li>If the <tt class="docutils literal">sender</tt>'s power level is greater than or equal to the <em>ban
level</em>, and the <em>target user</em>'s power level is less than the
<tt class="docutils literal">sender</tt>'s power level, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>Otherwise, the membership is unknown. Reject.</li>
</ol>
</li>
<li>If the <tt class="docutils literal">sender</tt>'s current membership state is not <tt class="docutils literal">join</tt>, reject.</li>
<li>If the event type's <em>required power level</em> is greater than the <tt class="docutils literal">sender</tt>'s power
level, reject.</li>
<li>If type is <tt class="docutils literal">m.room.power_levels</tt>:<ol class="loweralpha">
<li>If there is no previous <tt class="docutils literal">m.room.power_levels</tt> event in the room, allow.</li>
<li>For each of the keys <tt class="docutils literal">users_default</tt>, <tt class="docutils literal">events_default</tt>,
<tt class="docutils literal">state_default</tt>, <tt class="docutils literal">ban</tt>, <tt class="docutils literal">redact</tt>, <tt class="docutils literal">kick</tt>, <tt class="docutils literal">invite</tt>, as well as
each entry being changed under the <tt class="docutils literal">events</tt> or <tt class="docutils literal">users</tt> keys:<ol class="lowerroman">
<li>If the current value is higher than the <tt class="docutils literal">sender</tt>'s current power level,
reject.</li>
<li>If the new value is higher than the <tt class="docutils literal">sender</tt>'s current power level,
reject.</li>
</ol>
</li>
<li>For each entry being changed under the <tt class="docutils literal">users</tt> key, other than the
<tt class="docutils literal">sender</tt>'s own entry:<ol class="lowerroman">
<li>If the current value is equal to the <tt class="docutils literal">sender</tt>'s current power level,
reject.</li>
</ol>
</li>
<li>Otherwise, allow.</li>
</ol>
</li>
<li>If type is <tt class="docutils literal">m.room.redaction</tt>:<ol class="arabic">
<li>If the <tt class="docutils literal">sender</tt>'s power level is greater than or equal to the <em>redact
level</em>, allow.</li>
<li>If the <tt class="docutils literal">sender</tt> of the event being redacted is the same as the
<tt class="docutils literal">sender</tt> of the <tt class="docutils literal">m.room.redaction</tt>, allow.</li>
<li>Otherwise, reject.</li>
</ol>
</li>
<li>Otherwise, allow.</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Some consequences of these rules:</p>
<ul class="last simple">
<li>Unless you are a member of the room, the only permitted operations (apart
from the intial create/join) are: joining a public room; accepting or
rejecting an invitation to a room.</li>
<li>To unban somebody, you must have power level greater than or equal to both
the kick <em>and</em> ban levels, <em>and</em> greater than the target user's power
level.</li>
</ul>
</div>
<!-- TODO-spec

I think there is some magic about 3pid invites too. -->
</div>
</div>
</div>
<p><a class="anchor" id="edus"></a></p>
<div class="section" id="edus">
<h1><a class="toc-backref" href="#id19">5&nbsp;&nbsp;&nbsp;EDUs</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This section may be misleading or inaccurate.</p>
</div>
<p>EDUs, by comparison to PDUs, do not have an ID, a room ID, or a list of
&quot;previous&quot; IDs. The only mandatory fields for these are the type, origin and
destination homeserver names, and the actual nested content.</p>
<table border="1" class="docutils">
<colgroup>
<col width="31%" />
<col width="16%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">edu_type</tt></td>
<td>String</td>
<td>The type of the ephemeral message.</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>Content of the ephemeral message.</td>
</tr>
</tbody>
</table>
<pre class="code json literal-block">
<span class="punctuation">{</span>
 <span class="name tag">&quot;edu_type&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;m.presence&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;blue&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;destination&quot;</span><span class="punctuation">:</span><span class="literal string double">&quot;orange&quot;</span><span class="punctuation">,</span>
 <span class="name tag">&quot;content&quot;</span><span class="punctuation">:{</span><span class="error">...</span><span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
<p><a class="anchor" id="room-state-resolution"></a></p>
<div class="section" id="room-state-resolution">
<h1><a class="toc-backref" href="#id20">6&nbsp;&nbsp;&nbsp;Room State Resolution</a></h1>
<p>The <em>state</em> of a room is a map of <tt class="docutils literal">(event_type, state_key)</tt> to
<tt class="docutils literal">event_id</tt>. Each room starts with an empty state, and each state event which
is accepted into the room updates the state of that room.</p>
<p>Where each event has a single <tt class="docutils literal">prev_event</tt>, it is clear what the state of the
room after each event should be. However, when two branches in the event graph
merge, the state of those branches might differ, so a <em>state resolution</em>
algorithm must be used to determine the resultant state.</p>
<p>For example, consider the following event graph (where the oldest event, E0,
is at the top):</p>
<pre class="literal-block">
  E0
  |
  E1
 /  \
E2  E4
|    |
E3   |
 \  /
  E5
</pre>
<p>Suppose E3 and E4 are both <tt class="docutils literal">m.room.name</tt> events which set the name of the
room. What should the name of the room be at E5?</p>
<p>Servers should follow the following recursively-defined algorithm to determine
the room state at a given point on the DAG.</p>
<p><a class="anchor" id="state-resolution-algorithm"></a></p>
<div class="section" id="state-resolution-algorithm">
<h2><a class="toc-backref" href="#id21">6.1&nbsp;&nbsp;&nbsp;State resolution algorithm</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This section documents the state resolution algorithm as implemented by
Synapse as of December 2017 (and therefore the de-facto Matrix protocol).
However, this algorithm is known to have some problems.</p>
</div>
<p>The room state <span class="formula"><i>S</i>’(<i>E</i>)</span> after an event <span class="formula"><i>E</i></span> is defined in terms of
the room state <span class="formula"><i>S</i>(<i>E</i>)</span> before <span class="formula"><i>E</i></span>, and depends on whether
<span class="formula"><i>E</i></span> is a state event or a message event:</p>
<ul class="simple">
<li>If <span class="formula"><i>E</i></span> is a message event, then <span class="formula"><i>S</i>’(<i>E</i>) = <i>S</i>(<i>E</i>)</span>.</li>
<li>If <span class="formula"><i>E</i></span> is a state event, then <span class="formula"><i>S</i>’(<i>E</i>)</span> is <span class="formula"><i>S</i>(<i>E</i>)</span>, except
that its entry corresponding to <span class="formula"><i>E</i></span>'s <tt class="docutils literal">event_type</tt> and <tt class="docutils literal">state_key</tt>
is replaced by <span class="formula"><i>E</i></span>'s <tt class="docutils literal">event_id</tt>.</li>
</ul>
<p>The room state <span class="formula"><i>S</i>(<i>E</i>)</span> before <span class="formula"><i>E</i></span> is the <em>resolution</em> of the set of
states <span class="formula">{<i>S</i>’(<i>E</i>’), <i>S</i>’(<i>E</i>’’), …}</span> consisting of the states after each of
<span class="formula"><i>E</i></span>'s <tt class="docutils literal">prev_event</tt>s <span class="formula">{<i>E</i>’, <i>E</i>’’, …}</span>.</p>
<p>The <em>resolution</em> of a set of states is defined as follows.  The resolved state
is built up in a number of passes; here we use <span class="formula"><i>R</i></span> to refer to the
results of the resolution so far.</p>
<ul class="simple">
<li>Start by setting <span class="formula"><i>R</i></span> to the union of the states to be resolved,
excluding any <em>conflicting</em> events.</li>
<li>First we resolve conflicts between <tt class="docutils literal">m.room.power_levels</tt> events. If there
is no conflict, this step is skipped, otherwise:<ul>
<li>Assemble all the <tt class="docutils literal">m.room.power_levels</tt> events from the states to
be resolved into a list.</li>
<li>Sort the list by ascending <tt class="docutils literal">depth</tt> then descending <tt class="docutils literal">sha1(event_id)</tt>.</li>
<li>Add the first event in the list to <span class="formula"><i>R</i></span>.</li>
<li>For each subsequent event in the list, check that the event would be
allowed by the <a class="reference internal" href="#authorization-rules">authorization rules</a> for a room in state <span class="formula"><i>R</i></span>. If the
event would be allowed, then update <span class="formula"><i>R</i></span> with the event and continue
with the next event in the list. If it would not be allowed, stop and
continue below with <tt class="docutils literal">m.room.join_rules</tt> events.</li>
</ul>
</li>
<li>Repeat the above process for conflicts between <tt class="docutils literal">m.room.join_rules</tt> events.</li>
<li>Repeat the above process for conflicts between <tt class="docutils literal">m.room.member</tt> events.</li>
<li>No other events affect the authorization rules, so for all other conflicts,
just pick the event with the highest depth and lowest <tt class="docutils literal">sha1(event_id)</tt> that
passes authentication in <span class="formula"><i>R</i></span> and add it to <span class="formula"><i>R</i></span>.</li>
</ul>
<p>A <em>conflict</em> occurs between states where those states have different
<tt class="docutils literal">event_ids</tt> for the same <tt class="docutils literal">(state_type, state_key)</tt>. The events thus
affected are said to be <em>conflicting</em> events.</p>
</div>
</div>
<p><a class="anchor" id="protocol-urls"></a></p>
<div class="section" id="protocol-urls">
<h1><a class="toc-backref" href="#id22">7&nbsp;&nbsp;&nbsp;Protocol URLs</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This section may be misleading or inaccurate.</p>
</div>
<p>All these URLs are name-spaced within a prefix of:</p>
<pre class="literal-block">
/_matrix/federation/v1/...
</pre>
<p>For active pushing of messages representing live activity &quot;as it happens&quot;:</p>
<pre class="literal-block">
PUT .../send/&lt;transaction_id&gt;/
  Body: JSON encoding of a single Transaction
  Response: TODO-doc
</pre>
<p>The transaction_id path argument will override any ID given in the JSON body.
The destination name will be set to that of the receiving server itself. Each
embedded PDU in the transaction body will be processed.</p>
<p>To fetch all the state of a given room:</p>
<pre class="literal-block">
GET .../state/&lt;room_id&gt;/
  Response: JSON encoding of a single Transaction containing multiple PDUs
</pre>
<p>Retrieves a snapshot of the entire current state of the given room. The
response will contain a single Transaction, inside which will be a list of PDUs
that encode the state.</p>
<p>To fetch a particular event:</p>
<pre class="literal-block">
GET .../event/&lt;event_id&gt;/
  Response: JSON encoding of a partial Transaction containing the event
</pre>
<p>Retrieves a single event. The response will contain a partial Transaction,
having just the <tt class="docutils literal">origin</tt>, <tt class="docutils literal">origin_server_ts</tt> and <tt class="docutils literal">pdus</tt> fields; the
event will be encoded as the only PDU in the <tt class="docutils literal">pdus</tt> list.</p>
<p>To backfill events on a given room:</p>
<pre class="literal-block">
GET .../backfill/&lt;room_id&gt;/
  Query args: v, limit
  Response: JSON encoding of a single Transaction containing multiple PDUs
</pre>
<p>Retrieves a sliding-window history of previous PDUs that occurred on the given
room. Starting from the PDU ID(s) given in the &quot;v&quot; argument, the PDUs that
preceded it are retrieved, up to a total number given by the &quot;limit&quot; argument.</p>
<p>To stream events all the events:</p>
<pre class="literal-block">
GET .../pull/
  Query args: origin, v
  Response: JSON encoding of a single Transaction consisting of multiple PDUs
</pre>
<p>Retrieves all of the transactions later than any version given by the &quot;v&quot;
arguments.</p>
<p>To make a query:</p>
<pre class="literal-block">
GET .../query/&lt;query_type&gt;
  Query args: as specified by the individual query types
  Response: JSON encoding of a response object
</pre>
<p>Performs a single query request on the receiving homeserver. The Query Type
part of the path specifies the kind of query being made, and its query
arguments have a meaning specific to that kind of query. The response is a
JSON-encoded object whose meaning also depends on the kind of query.</p>
<p>To join a room:</p>
<pre class="literal-block">
GET .../make_join/&lt;room_id&gt;/&lt;user_id&gt;
  Response: JSON encoding of a join proto-event

PUT .../send_join/&lt;room_id&gt;/&lt;event_id&gt;
  Response: JSON encoding of the state of the room at the time of the event
</pre>
<p>Performs the room join handshake. For more information, see &quot;Joining Rooms&quot;
below.</p>
</div>
<p><a class="anchor" id="joining-rooms"></a></p>
<div class="section" id="joining-rooms">
<h1><a class="toc-backref" href="#id23">8&nbsp;&nbsp;&nbsp;Joining Rooms</a></h1>
<p>When a new user wishes to join room that the user's homeserver already knows
about, the homeserver can immediately determine if this is allowable by
inspecting the state of the room, and if it is acceptable, it can generate,
sign, and emit a new <tt class="docutils literal">m.room.member</tt> state event adding the user into that
room. When the homeserver does not yet know about the room it cannot do this
directly. Instead, it must take a longer multi-stage handshaking process by
which it first selects a remote homeserver which is already participating in
that room, and uses it to assist in the joining process. This is the remote
join handshake.</p>
<p>This handshake involves the homeserver of the new member wishing to join
(referred to here as the &quot;joining&quot; server), the directory server hosting the
room alias the user is requesting to join with, and a homeserver where existing
room members are already present (referred to as the &quot;resident&quot; server).</p>
<p>In summary, the remote join handshake consists of the joining server querying
the directory server for information about the room alias; receiving a room ID
and a list of join candidates. The joining server then requests information
about the room from one of the residents. It uses this information to construct
a <tt class="docutils literal">m.room.member</tt> event which it finally sends to a resident server.</p>
<p>Conceptually these are three different roles of homeserver. In practice the
directory server is likely to be resident in the room, and so may be selected
by the joining server to be the assisting resident. Likewise, it is likely that
the joining server picks the same candidate resident for both phases of event
construction, though in principle any valid candidate may be used at each time.
Thus, any join handshake can potentially involve anywhere from two to four
homeservers, though most in practice will use just two.</p>
<pre class="literal-block">
Client         Joining                Directory       Resident
               Server                 Server          Server

join request --&gt;
               |
               directory request -------&gt;
               &lt;---------- directory response
               |
               make_join request -----------------------&gt;
               &lt;------------------------------- make_join response
               |
               send_join request -----------------------&gt;
               &lt;------------------------------- send_join response
               |
&lt;---------- join response
</pre>
<p>The first part of the handshake usually involves using the directory server to
request the room ID and join candidates. This is covered in more detail on the
directory server documentation, below. In the case of a new user joining a
room as a result of a received invite, the joining user's homeserver could
optimise this step away by picking the origin server of that invite message as
the join candidate. However, the joining server should be aware that the origin
server of the invite might since have left the room, so should be prepared to
fall back on the regular join flow if this optimisation fails.</p>
<p>Once the joining server has the room ID and the join candidates, it then needs
to obtain enough information about the room to fill in the required fields of
the <tt class="docutils literal">m.room.member</tt> event. It obtains this by selecting a resident from the
candidate list, and requesting the <tt class="docutils literal">make_join</tt> endpoint using a <tt class="docutils literal">GET</tt>
request, specifying the room ID and the user ID of the new member who is
attempting to join.</p>
<p>The resident server replies to this request with a JSON-encoded object having a
single key called <tt class="docutils literal">event</tt>; within this is an object whose fields contain some
of the information that the joining server will need. Despite its name, this
object is not a full event; notably it does not need to be hashed or signed by
the resident homeserver. The required fields are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="10%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">type</tt></td>
<td>String</td>
<td>The value <tt class="docutils literal">m.room.member</tt></td>
</tr>
<tr><td><tt class="docutils literal">auth_events</tt></td>
<td>List</td>
<td>An event-reference list containing the
authorization events that would allow this member
to join</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>The event content</td>
</tr>
<tr><td><tt class="docutils literal">depth</tt></td>
<td>Integer</td>
<td>(this field must be present but is ignored; it
may be 0)</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the resident homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the resident homeserver</td>
</tr>
<tr><td><tt class="docutils literal">prev_events</tt></td>
<td>List</td>
<td>An event-reference list containing the immediate
predecessor events</td>
</tr>
<tr><td><tt class="docutils literal">room_id</tt></td>
<td>String</td>
<td>The room ID of the room</td>
</tr>
<tr><td><tt class="docutils literal">sender</tt></td>
<td>String</td>
<td>The user ID of the joining member</td>
</tr>
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>The user ID of the joining member</td>
</tr>
</tbody>
</table>
<p>The <tt class="docutils literal">content</tt> field itself must be an object, containing:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="16%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">membership</tt></td>
<td>String</td>
<td>The value <tt class="docutils literal">join</tt></td>
</tr>
</tbody>
</table>
<p>The joining server now has sufficient information to construct the real join
event from these protoevent fields. It copies the values of most of them,
adding (or replacing) the following fields:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="9%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">event_id</tt></td>
<td>String</td>
<td>A new event ID specified by the joining homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the joining homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the joining homeserver</td>
</tr>
</tbody>
</table>
<p>This will be a true event, so the joining server should apply the event-signing
algorithm to it, resulting in the addition of the <tt class="docutils literal">hashes</tt> and <tt class="docutils literal">signatures</tt>
fields.</p>
<p>To complete the join handshake, the joining server must now submit this new
event to an resident homeserver, by using the <tt class="docutils literal">send_join</tt> endpoint. This is
invoked using the room ID and the event ID of the new member event.</p>
<p>The resident homeserver then accepts this event into the room's event graph,
and responds to the joining server with the full set of state for the newly-
joined room. This is returned as a two-element list, whose first element is the
integer 200, and whose second element is an object which contains the
following keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="7%" />
<col width="74%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">auth_chain</tt></td>
<td>List</td>
<td>A list of events giving all of the events in the auth
chains for the join event and the events in <tt class="docutils literal">state</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">state</tt></td>
<td>List</td>
<td>A complete list of the prevailing state events at the
instant just before accepting the new <tt class="docutils literal">m.room.member</tt>
event.</td>
</tr>
</tbody>
</table>
<!-- TODO-spec
- (paul) I don't really understand why the full auth_chain events are given
  here. What purpose does it serve expanding them out in full, when surely
  they'll appear in the state anyway? -->
</div>
<p><a class="anchor" id="backfilling"></a></p>
<div class="section" id="backfilling">
<h1><a class="toc-backref" href="#id24">9&nbsp;&nbsp;&nbsp;Backfilling</a></h1>
<p>Once a homeserver has joined a room, it receives all the events emitted by
other homeservers in that room, and is thus aware of the entire history of the
room from that moment onwards. Since users in that room are able to request the
history by the <tt class="docutils literal">/messages</tt> client API endpoint, it's possible that they might
step backwards far enough into history before the homeserver itself was a
member of that room.</p>
<p>To cover this case, the federation API provides a server-to-server analog of
the <tt class="docutils literal">/messages</tt> client API, allowing one homeserver to fetch history from
another. This is the <tt class="docutils literal">/backfill</tt> API.</p>
<p>To request more history, the requesting homeserver picks another homeserver
that it thinks may have more (most likely this should be a homeserver for some
of the existing users in the room at the earliest point in history it has
currently), and makes a <tt class="docutils literal">/backfill</tt> request. The parameters of this request
give an event ID that the requesting homeserver wishes to obtain, and a number
specifying how many more events of history before that one to return at most.</p>
<p>The response to this request is an object with the following keys:</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="11%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">pdus</tt></td>
<td>List</td>
<td>A list of events</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the resident homeserver</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the resident homeserver</td>
</tr>
</tbody>
</table>
<p>The list of events given in <tt class="docutils literal">pdus</tt> is returned in reverse chronological
order; having the most recent event first (i.e. the event whose event ID is
that requested by the requestor in the <tt class="docutils literal">v</tt> parameter).</p>
<!-- TODO-spec
Specify (or remark that it is unspecified) how the server handles divergent
history. DFS? BFS? Anything weirder? -->
</div>
<p><a class="anchor" id="inviting-to-a-room"></a></p>
<div class="section" id="inviting-to-a-room">
<h1><a class="toc-backref" href="#id25">10&nbsp;&nbsp;&nbsp;Inviting to a room</a></h1>
<p>When a user wishes to invite an other user to a local room and the other user
is on a different server, the inviting server will send a request to the invited
server:</p>
<pre class="literal-block">
PUT .../invite/{roomId}/{eventId}
</pre>
<p>The required fields in the JSON body are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="10%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">room_id</tt></td>
<td>String</td>
<td>The room ID of the room. Must be the same as the
room ID specified in the path.</td>
</tr>
<tr><td><tt class="docutils literal">event_id</tt></td>
<td>String</td>
<td>The ID of the event. Must be the same as the event
ID specified in the path.</td>
</tr>
<tr><td><tt class="docutils literal">type</tt></td>
<td>String</td>
<td>The value <tt class="docutils literal">m.room.member</tt>.</td>
</tr>
<tr><td><tt class="docutils literal">auth_events</tt></td>
<td>List</td>
<td>An event-reference list containing the IDs of the
authorization events that would allow this member
to be invited in the room.</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>The content of the event.</td>
</tr>
<tr><td><tt class="docutils literal">depth</tt></td>
<td>Integer</td>
<td>The depth of the event.</td>
</tr>
<tr><td><tt class="docutils literal">origin</tt></td>
<td>String</td>
<td>The name of the inviting homeserver.</td>
</tr>
<tr><td><tt class="docutils literal">origin_server_ts</tt></td>
<td>Integer</td>
<td>A timestamp added by the inviting homeserver.</td>
</tr>
<tr><td><tt class="docutils literal">prev_events</tt></td>
<td>List</td>
<td>An event-reference list containing the IDs of the
immediate predecessor events.</td>
</tr>
<tr><td><tt class="docutils literal">sender</tt></td>
<td>String</td>
<td>The Matrix ID of the user who sent the original
<cite>m.room.third_party_invite</cite>.</td>
</tr>
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>The Matrix ID of the invited user.</td>
</tr>
<tr><td><tt class="docutils literal">signatures</tt></td>
<td>Object</td>
<td>The signature of the event from the origin server.</td>
</tr>
<tr><td><tt class="docutils literal">unsigned</tt></td>
<td>Object</td>
<td>An object containing the properties that aren't
part of the signature's computation.</td>
</tr>
</tbody>
</table>
<p>Where the <tt class="docutils literal">content</tt> key contains the content for the <tt class="docutils literal">m.room.member</tt> event
specified in the <a class="reference external" href="../client_server/unstable.html#m-room-member">Client-Server API</a>. Note that the <tt class="docutils literal">membership</tt> property of
the content must be <tt class="docutils literal">invite</tt>.</p>
<p>Upon receiving this request, the invited homeserver will append its signature to
the event and respond to the request with the following JSON body:</p>
<pre class="literal-block">
[
  200,
  &quot;event&quot;: {...}
]
</pre>
<p>Where <tt class="docutils literal">event</tt> contains the event signed by both homeservers, using the same
JSON keys as the initial request on <tt class="docutils literal"><span class="pre">/invite/{roomId}/{eventId}</span></tt>. Note that,
except for the <tt class="docutils literal">signatures</tt> object (which now contains an additional signature),
all of the event's keys remain the same as in the event initially provided.</p>
<p>This response format is due to a typo in Synapse, the first implementation of
Matrix's APIs, and is preserved to maintain compatibility.</p>
<p>Now that the event has been signed by both the inviting homeserver and the
invited homeserver, it can be sent to all of the users in the room.</p>
</div>
<p><a class="anchor" id="third-party-invites"></a></p>
<div class="section" id="third-party-invites">
<h1><a class="toc-backref" href="#id26">11&nbsp;&nbsp;&nbsp;Third-party invites</a></h1>
<p>When an user wants to invite another user in a room but doesn't know the Matrix
ID to invite, they can do so using a third-party identifier (e.g. an e-mail or a
phone number).</p>
<p>This identifier and its bindings to Matrix IDs are verified by an identity server
implementing the <a class="reference external" href="../identity_service/unstable.html">Identity Service API</a>.</p>
<p><a class="anchor" id="cases-where-an-association-exists-for-a-third-party-identifier"></a></p>
<div class="section" id="cases-where-an-association-exists-for-a-third-party-identifier">
<h2><a class="toc-backref" href="#id27">11.1&nbsp;&nbsp;&nbsp;Cases where an association exists for a third-party identifier</a></h2>
<p>If the third-party identifier is already bound to a Matrix ID, a lookup request
on the identity server will return it. The invite is then processed by the inviting
homeserver as a standard <tt class="docutils literal">m.room.member</tt> invite event. This is the simplest case.</p>
</div>
<p><a class="anchor" id="cases-where-an-association-doesn-t-exist-for-a-third-party-identifier"></a></p>
<div class="section" id="cases-where-an-association-doesn-t-exist-for-a-third-party-identifier">
<h2><a class="toc-backref" href="#id28">11.2&nbsp;&nbsp;&nbsp;Cases where an association doesn't exist for a third-party identifier</a></h2>
<p>If the third-party identifier isn't bound to any Matrix ID, the inviting
homeserver will request the identity server to store an invite for this identifier
and to deliver it to whoever binds it to its Matrix ID. It will also send a
<tt class="docutils literal">m.room.third_party_invite</tt> event in the room to specify a display name, a token
and public keys the identity server provided as a response to the invite storage
request.</p>
<p>When a third-party identifier with pending invites gets bound to a Matrix ID,
the identity server will send a <tt class="docutils literal">POST</tt> request to the ID's homeserver as described
in the <a class="reference external" href="../identity_service/unstable.html#invitation-storage">Invitation Storage</a> section of the Identity Service API.</p>
<p>The following process applies for each invite sent by the identity server:</p>
<p>The invited homeserver will create a <tt class="docutils literal">m.room.member</tt> invite event containing
a special <tt class="docutils literal">third_party_invite</tt> section containing the token and a signed object,
both provided by the identity server.</p>
<p>If the invited homeserver is in the room the invite came from, it can auth the
event and send it.</p>
<p>However, if the invited homeserver isn't in the room the invite came from, it
will need to request the room's homeserver to auth the event:</p>
<pre class="literal-block">
PUT .../exchange_third_party_invite/{roomId}
</pre>
<p>Where <tt class="docutils literal">roomId</tt> is the ID of the room the invite is for.</p>
<p>The required fields in the JSON body are:</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="9%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Key</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">type</tt></td>
<td>String</td>
<td>The event type. Must be <cite>m.room.member</cite>.</td>
</tr>
<tr><td><tt class="docutils literal">room_id</tt></td>
<td>String</td>
<td>The ID of the room the event is for. Must be the
same as the ID specified in the path.</td>
</tr>
<tr><td><tt class="docutils literal">sender</tt></td>
<td>String</td>
<td>The Matrix ID of the user who sent the original
<cite>m.room.third_party_invite</cite>.</td>
</tr>
<tr><td><tt class="docutils literal">state_key</tt></td>
<td>String</td>
<td>The Matrix ID of the invited user.</td>
</tr>
<tr><td><tt class="docutils literal">content</tt></td>
<td>Object</td>
<td>The content of the event.</td>
</tr>
</tbody>
</table>
<p>Where the <tt class="docutils literal">content</tt> key contains the content for the <tt class="docutils literal">m.room.member</tt> event
as described in the <a class="reference external" href="../client_server/unstable.html#m-room-member">Client-Server API</a>. Its <tt class="docutils literal">membership</tt> key must be
<tt class="docutils literal">invite</tt> and its content must include the <tt class="docutils literal">third_party_invite</tt> object.</p>
<p>The inviting homeserver will then be able to authenticate the event. It will send
a fully authenticated event to the invited homeserver as described in the <a class="reference external" href="#inviting-to-a-room">Inviting
to a room</a> section above.</p>
<p>Once the invited homeserver responded with the event to which it appended its
signature, the inviting homeserver will respond with <tt class="docutils literal">200 OK</tt> and an empty body
(<tt class="docutils literal">{}</tt>) to the initial request on <tt class="docutils literal"><span class="pre">/exchange_third_party_invite/{roomId}</span></tt> and
send the now verified <tt class="docutils literal">m.room.member</tt> invite event to the room's members.</p>
<p><a class="anchor" id="verifying-the-invite"></a></p>
<div class="section" id="verifying-the-invite">
<h3><a class="toc-backref" href="#id29">11.2.1&nbsp;&nbsp;&nbsp;Verifying the invite</a></h3>
<p>When a homeserver receives a <tt class="docutils literal">m.room.member</tt> invite event for a room it's in
with a <tt class="docutils literal">third_party_invite</tt> object, it must verify that the association between
the third-party identifier initially invited to the room and the Matrix ID that
claims to be bound to it has been verified without having to rely on a third-party
server.</p>
<p>To do so, it will fetch from the room's state events the <tt class="docutils literal">m.room.third_party_invite</tt>
event for which the state key matches with the value for the <tt class="docutils literal">token</tt> key in the
<tt class="docutils literal">third_party_invite</tt> object from the <tt class="docutils literal">m.room.member</tt> event's content to fetch the
public keys initially delivered by the identity server that stored the invite.</p>
<p>It will then use these keys to verify that the <tt class="docutils literal">signed</tt> object (in the
<tt class="docutils literal">third_party_invite</tt> object from the <tt class="docutils literal">m.room.member</tt> event's content) was
signed by the same identity server.</p>
<p>Since this <tt class="docutils literal">signed</tt> object can only be delivered once in the <tt class="docutils literal">POST</tt> request
emitted by the identity server upon binding between the third-party identifier
and the Matrix ID, and contains the invited user's Matrix ID and the token
delivered when the invite was stored, this verification will prove that the
<tt class="docutils literal">m.room.member</tt> invite event comes from the user owning the invited third-party
identifier.</p>
</div>
</div>
</div>
<p><a class="anchor" id="authentication"></a></p>
<div class="section" id="authentication">
<h1><a class="toc-backref" href="#id30">12&nbsp;&nbsp;&nbsp;Authentication</a></h1>
<p><a class="anchor" id="request-authentication"></a></p>
<div class="section" id="request-authentication">
<h2><a class="toc-backref" href="#id31">12.1&nbsp;&nbsp;&nbsp;Request Authentication</a></h2>
<p>Every HTTP request made by a homeserver is authenticated using public key
digital signatures. The request method, target and body are signed by wrapping
them in a JSON object and signing it using the JSON signing algorithm. The
resulting signatures are added as an Authorization header with an auth scheme
of X-Matrix. Note that the target field should include the full path starting with
<tt class="docutils literal"><span class="pre">/_matrix/...</span></tt>, including the <tt class="docutils literal">?</tt> and any query parameters if present, but
should not include the leading <tt class="docutils literal">https:</tt>, nor the destination server's
hostname.</p>
<p>Step 1 sign JSON:</p>
<pre class="code literal-block">
 {
     &quot;method&quot;: &quot;GET&quot;,
     &quot;uri&quot;: &quot;/target&quot;,
     &quot;origin&quot;: &quot;origin.hs.example.com&quot;,
     &quot;destination&quot;: &quot;destination.hs.example.com&quot;,
     &quot;content&quot;: &lt;request body&gt;,
     &quot;signatures&quot;: {
         &quot;origin.hs.example.com&quot;: {
             &quot;ed25519:key1&quot;: &quot;ABCDEF...&quot;
         }
     }
}
</pre>
<p>Step 2 add Authorization header:</p>
<pre class="code literal-block">
GET /target HTTP/1.1
Authorization: X-Matrix origin=origin.example.com,key=&quot;ed25519:key1&quot;,sig=&quot;ABCDEF...&quot;
Content-Type: application/json

&lt;JSON-encoded request body&gt;
</pre>
<p>Example python code:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">authorization_headers</span><span class="punctuation">(</span><span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">origin_signing_key</span><span class="punctuation">,</span>
                          <span class="name">destination_name</span><span class="punctuation">,</span> <span class="name">request_method</span><span class="punctuation">,</span> <span class="name">request_target</span><span class="punctuation">,</span>
                          <span class="name">content</span><span class="operator">=</span><span class="name builtin pseudo">None</span><span class="punctuation">):</span>
    <span class="name">request_json</span> <span class="operator">=</span> <span class="punctuation">{</span>
         <span class="literal string double">&quot;method&quot;</span><span class="punctuation">:</span> <span class="name">request_method</span><span class="punctuation">,</span>
         <span class="literal string double">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="name">request_target</span><span class="punctuation">,</span>
         <span class="literal string double">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="name">origin_name</span><span class="punctuation">,</span>
         <span class="literal string double">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="name">destination_name</span><span class="punctuation">,</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="name">content_json</span> <span class="operator word">is</span> <span class="operator word">not</span> <span class="name builtin pseudo">None</span><span class="punctuation">:</span>
        <span class="name">request</span><span class="punctuation">[</span><span class="literal string double">&quot;content&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">content</span>

    <span class="name">signed_json</span> <span class="operator">=</span> <span class="name">sign_json</span><span class="punctuation">(</span><span class="name">request_json</span><span class="punctuation">,</span> <span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">origin_signing_key</span><span class="punctuation">)</span>

    <span class="name">authorization_headers</span> <span class="operator">=</span> <span class="punctuation">[]</span>

    <span class="keyword">for</span> <span class="name">key</span><span class="punctuation">,</span> <span class="name">sig</span> <span class="operator word">in</span> <span class="name">signed_json</span><span class="punctuation">[</span><span class="literal string double">&quot;signatures&quot;</span><span class="punctuation">][</span><span class="name">origin_name</span><span class="punctuation">]</span><span class="operator">.</span><span class="name">items</span><span class="punctuation">():</span>
        <span class="name">authorization_headers</span><span class="operator">.</span><span class="name">append</span><span class="punctuation">(</span><span class="name builtin">bytes</span><span class="punctuation">(</span>
            <span class="literal string double">&quot;X-Matrix origin=</span><span class="literal string interpol">%s</span><span class="literal string double">,key=</span><span class="literal string escape">\&quot;</span><span class="literal string interpol">%s</span><span class="literal string escape">\&quot;</span><span class="literal string double">,sig=</span><span class="literal string escape">\&quot;</span><span class="literal string interpol">%s</span><span class="literal string escape">\&quot;</span><span class="literal string double">&quot;</span> <span class="operator">%</span> <span class="punctuation">(</span>
                <span class="name">origin_name</span><span class="punctuation">,</span> <span class="name">key</span><span class="punctuation">,</span> <span class="name">sig</span><span class="punctuation">,</span>
            <span class="punctuation">)</span>
        <span class="punctuation">))</span>

    <span class="keyword">return</span> <span class="punctuation">(</span><span class="literal string double">&quot;Authorization&quot;</span><span class="punctuation">,</span> <span class="name">authorization_headers</span><span class="punctuation">)</span>
</pre>
</div>
<p><a class="anchor" id="response-authentication"></a></p>
<div class="section" id="response-authentication">
<h2><a class="toc-backref" href="#id32">12.2&nbsp;&nbsp;&nbsp;Response Authentication</a></h2>
<p>Responses are authenticated by the TLS server certificate. A homeserver should
not send a request until it has authenticated the connected server to avoid
leaking messages to eavesdroppers.</p>
</div>
<p><a class="anchor" id="client-tls-certificates"></a></p>
<div class="section" id="client-tls-certificates">
<h2><a class="toc-backref" href="#id33">12.3&nbsp;&nbsp;&nbsp;Client TLS Certificates</a></h2>
<p>Requests are authenticated at the HTTP layer rather than at the TLS layer
because HTTP services like Matrix are often deployed behind load balancers that
handle the TLS and these load balancers make it difficult to check TLS client
certificates.</p>
<p>A homeserver may provide a TLS client certificate and the receiving homeserver
may check that the client certificate matches the certificate of the origin
homeserver.</p>
</div>
</div>
<p><a class="anchor" id="presence"></a></p>
<div class="section" id="presence">
<h1><a class="toc-backref" href="#id34">13&nbsp;&nbsp;&nbsp;Presence</a></h1>
<p>The server API for presence is based entirely on exchange of the following
EDUs. There are no PDUs or Federation Queries involved.</p>
<p>Performing a presence update and poll subscription request:</p>
<pre class="literal-block">
EDU type: m.presence

Content keys:
  push: (optional): list of push operations.
    Each should be an object with the following keys:
      user_id: string containing a User ID
      presence: &quot;offline&quot;|&quot;unavailable&quot;|&quot;online&quot;|&quot;free_for_chat&quot;
      status_msg: (optional) string of free-form text
      last_active_ago: milliseconds since the last activity by the user

  poll: (optional): list of strings giving User IDs

  unpoll: (optional): list of strings giving User IDs
</pre>
<p>The presence of this combined message is two-fold: it informs the recipient
server of the current status of one or more users on the sending server (by the
<tt class="docutils literal">push</tt> key), and it maintains the list of users on the recipient server that
the sending server is interested in receiving updates for, by adding (by the
<tt class="docutils literal">poll</tt> key) or removing them (by the <tt class="docutils literal">unpoll</tt> key). The <tt class="docutils literal">poll</tt> and
<tt class="docutils literal">unpoll</tt> lists apply <em>changes</em> to the implied list of users; any existing IDs
that the server sent as <tt class="docutils literal">poll</tt> operations in a previous message are not
removed until explicitly requested by a later <tt class="docutils literal">unpoll</tt>.</p>
<p>On receipt of a message containing a non-empty <tt class="docutils literal">poll</tt> list, the receiving
server should immediately send the sending server a presence update EDU of its
own, containing in a <tt class="docutils literal">push</tt> list the current state of every user that was in
the original EDU's <tt class="docutils literal">poll</tt> list.</p>
<p>Sending a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_invite

Content keys:
  observed_user: string giving the User ID of the user whose presence is
    requested (i.e. the recipient of the invite)
  observer_user: string giving the User ID of the user who is requesting to
    observe the presence (i.e. the sender of the invite)
</pre>
<p>Accepting a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_accept

Content keys - as for m.presence_invite
</pre>
<p>Rejecting a presence invite:</p>
<pre class="literal-block">
EDU type: m.presence_deny

Content keys - as for m.presence_invite
</pre>
<!-- TODO-doc
- Explain the timing-based round-trip reduction mechanism for presence
  messages
- Explain the zero-byte presence inference logic
See also: docs/client-server/model/presence -->
</div>
<p><a class="anchor" id="profiles"></a></p>
<div class="section" id="profiles">
<h1><a class="toc-backref" href="#id35">14&nbsp;&nbsp;&nbsp;Profiles</a></h1>
<p>The server API for profiles is based entirely on the following Federation
Queries. There are no additional EDU or PDU types involved, other than the
implicit <tt class="docutils literal">m.presence</tt> and <tt class="docutils literal">m.room.member</tt> events (see section below).</p>
<p>Querying profile information:</p>
<pre class="literal-block">
Query type: profile

Arguments:
  user_id: the ID of the user whose profile to return
  field: (optional) string giving a field name

Returns: JSON object containing the following keys:
  displayname: string of free-form text
  avatar_url: string containing an HTTP-scheme URL
</pre>
<p>If the query contains the optional <tt class="docutils literal">field</tt> key, it should give the name of a
result field. If such is present, then the result should contain only a field
of that name, with no others present. If not, the result should contain as much
of the user's profile as the homeserver has available and can make public.</p>
</div>
<p><a class="anchor" id="directory"></a></p>
<div class="section" id="directory">
<h1><a class="toc-backref" href="#id36">15&nbsp;&nbsp;&nbsp;Directory</a></h1>
<p>The server API for directory queries is also based on Federation Queries.</p>
<p><a class="anchor" id="get-matrix-federation-v1-query-directory"></a></p>
<div class="section" id="get-matrix-federation-v1-query-directory">
<h2><a class="toc-backref" href="#id37">15.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">GET /_matrix/federation/v1/query/directory</tt></a></h2>
<p>Retrieve the room ID and list of resident homeservers for a Room alias.</p>
<p>Request format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td colspan="3"><em>query parameters</em></td>
</tr>
<tr><td>room_alias</td>
<td>string</td>
<td><strong>Required.</strong> Room alias</td>
</tr>
</tbody>
</table>
<p>Response format:</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="14%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> The room ID mapped to the queried
room alias.</td>
</tr>
<tr><td>servers</td>
<td>[string]</td>
<td><strong>Required.</strong> An array of server names that are
likely to hold then given room. This list may or
may not include the server answering the query.</td>
</tr>
</tbody>
</table>
<p>Example request:</p>
<pre class="code http literal-block">
<span class="name function">GET</span> <span class="name namespace">/_matrix/federation/v1/query/directory?room_alias=%23room_alias%3Aexample.org</span> <span class="keyword reserved">HTTP</span><span class="operator">/</span><span class="literal number">1.1</span>
</pre>
<p>Response:</p>
<p><strong>Status code 200:</strong></p>
<p>The corresponding room ID and list of known resident homeservers for the room.</p>
<p>Example</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
  <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!roomid1234:example.org&quot;</span><span class="punctuation">,</span>
  <span class="name tag">&quot;servers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
    <span class="literal string double">&quot;example.org&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;example.com&quot;</span><span class="punctuation">,</span>
    <span class="literal string double">&quot;another.example.com:8449&quot;</span>
  <span class="punctuation">]</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="send-to-device-messaging"></a></p>
<div class="section" id="send-to-device-messaging">
<h1><a class="toc-backref" href="#id38">16&nbsp;&nbsp;&nbsp;Send-to-device messaging</a></h1>
<!-- TODO: add modules to the federation spec and make this a module -->
<p>The server API for send-to-device messaging is based on the following
EDU. There are no PDUs or Federation Queries involved.</p>
<p>Each send-to-device message should be sent to the destination server using
the following EDU:</p>
<pre class="literal-block">
EDU type: m.direct_to_device

Content keys:
  sender: user ID of the sender

  type: event type for the message

  message_id: unique id for the message: used for idempotence

  messages: The messages to send. A map from user ID, to a map from device ID
      to message body. The device ID may also be *, meaning all known devices
      for the user.
</pre>
</div>
<p><a class="anchor" id="signing-events"></a></p>
<div class="section" id="signing-events">
<h1><a class="toc-backref" href="#id39">17&nbsp;&nbsp;&nbsp;Signing Events</a></h1>
<p>Signing events is complicated by the fact that servers can choose to redact
non-essential parts of an event.</p>
<p>Before signing the event, the <tt class="docutils literal">unsigned</tt> and <tt class="docutils literal">signature</tt> members are
removed, it is encoded as <a class="reference external" href="../appendices.html#canonical-json">Canonical JSON</a>, and then hashed using SHA-256. The
resulting hash is then stored in the event JSON in a <tt class="docutils literal">hash</tt> object under a
<tt class="docutils literal">sha256</tt> key.</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">hash_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">):</span>

    <span class="comment single"># Keys under &quot;unsigned&quot; can be modified by other servers.</span>
    <span class="comment single"># They are useful for conveying information like the age of an</span>
    <span class="comment single"># event that will change in transit.</span>
    <span class="comment single"># Since they can be modifed we need to exclude them from the hash.</span>
    <span class="name">unsigned</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string double">&quot;unsigned&quot;</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">)</span>

    <span class="comment single"># Signatures will depend on the current value of the &quot;hashes&quot; key.</span>
    <span class="comment single"># We cannot add new hashes without invalidating existing signatures.</span>
    <span class="name">signatures</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string double">&quot;signatures&quot;</span><span class="punctuation">,</span> <span class="name builtin pseudo">None</span><span class="punctuation">)</span>

    <span class="comment single"># The &quot;hashes&quot; key might contain multiple algorithms if we decide to</span>
    <span class="comment single"># migrate away from SHA-2. We don't want to include an existing hash</span>
    <span class="comment single"># output in our hash so we exclude the &quot;hashes&quot; dict from the hash.</span>
    <span class="name">hashes</span> <span class="operator">=</span> <span class="name">event_json_object</span><span class="operator">.</span><span class="name">pop</span><span class="punctuation">(</span><span class="literal string double">&quot;hashes&quot;</span><span class="punctuation">,</span> <span class="punctuation">{})</span>

    <span class="comment single"># Encode the JSON using a canonical encoding so that we get the same</span>
    <span class="comment single"># bytes on every server for the same JSON object.</span>
    <span class="name">event_json_bytes</span> <span class="operator">=</span> <span class="name">encode_canonical_json</span><span class="punctuation">(</span><span class="name">event_json_bytes</span><span class="punctuation">)</span>

    <span class="comment single"># Add the base64 encoded bytes of the hash to the &quot;hashes&quot; dict.</span>
    <span class="name">hashes</span><span class="punctuation">[</span><span class="literal string double">&quot;sha256&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">encode_base64</span><span class="punctuation">(</span><span class="name">sha256</span><span class="punctuation">(</span><span class="name">event_json_bytes</span><span class="punctuation">)</span><span class="operator">.</span><span class="name">digest</span><span class="punctuation">())</span>

    <span class="comment single"># Add the &quot;hashes&quot; dict back the event JSON under a &quot;hashes&quot; key.</span>
    <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string double">&quot;hashes&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">hashes</span>
    <span class="keyword">if</span> <span class="name">unsigned</span> <span class="operator word">is</span> <span class="operator word">not</span> <span class="name builtin pseudo">None</span><span class="punctuation">:</span>
        <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string double">&quot;unsigned&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">unsigned</span>
    <span class="keyword">return</span> <span class="name">event_json_object</span>
</pre>
<p>The event is then stripped of all non-essential keys both at the top level and
within the <tt class="docutils literal">content</tt> object. Any top-level keys not in the following list
MUST be removed:</p>
<pre class="code literal-block">
auth_events
depth
event_id
hashes
membership
origin
origin_server_ts
prev_events
prev_state
room_id
sender
signatures
state_key
type
</pre>
<p>A new <tt class="docutils literal">content</tt> object is constructed for the resulting event that contains
only the essential keys of the original <tt class="docutils literal">content</tt> object. If the original
event lacked a <tt class="docutils literal">content</tt> object at all, a new empty JSON object is created
for it.</p>
<p>The keys that are considered essential for the <tt class="docutils literal">content</tt> object depend on the
the <tt class="docutils literal">type</tt> of the event. These are:</p>
<pre class="code literal-block">
type is &quot;m.room.aliases&quot;:
  aliases

type is &quot;m.room.create&quot;:
  creator

type is &quot;m.room.history_visibility&quot;:
  history_visibility

type is &quot;m.room.join_rules&quot;:
  join_rule

type is &quot;m.room.member&quot;:
  membership

type is &quot;m.room.power_levels&quot;:
  ban
  events
  events_default
  kick
  redact
  state_default
  users
  users_default
</pre>
<p>The resulting stripped object with the new <tt class="docutils literal">content</tt> object and the original
<tt class="docutils literal">hashes</tt> key is then signed using the JSON signing algorithm outlined below:</p>
<pre class="code python literal-block">
<span class="keyword">def</span> <span class="name function">sign_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">,</span> <span class="name">name</span><span class="punctuation">,</span> <span class="name">key</span><span class="punctuation">):</span>

    <span class="comment single"># Make sure the event has a &quot;hashes&quot; key.</span>
    <span class="keyword">if</span> <span class="literal string double">&quot;hashes&quot;</span> <span class="operator word">not</span> <span class="operator word">in</span> <span class="name">event_json_object</span><span class="punctuation">:</span>
        <span class="name">event_json_object</span> <span class="operator">=</span> <span class="name">hash_event</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">)</span>

    <span class="comment single"># Strip all the keys that would be removed if the event was redacted.</span>
    <span class="comment single"># The hashes are not stripped and cover all the keys in the event.</span>
    <span class="comment single"># This means that we can tell if any of the non-essential keys are</span>
    <span class="comment single"># modified or removed.</span>
    <span class="name">stripped_json_object</span> <span class="operator">=</span> <span class="name">strip_non_essential_keys</span><span class="punctuation">(</span><span class="name">event_json_object</span><span class="punctuation">)</span>

    <span class="comment single"># Sign the stripped JSON object. The signature only covers the</span>
    <span class="comment single"># essential keys and the hashes. This means that we can check the</span>
    <span class="comment single"># signature even if the event is redacted.</span>
    <span class="name">signed_json_object</span> <span class="operator">=</span> <span class="name">sign_json</span><span class="punctuation">(</span><span class="name">stripped_json_object</span><span class="punctuation">)</span>

    <span class="comment single"># Copy the signatures from the stripped event to the original event.</span>
    <span class="name">event_json_object</span><span class="punctuation">[</span><span class="literal string double">&quot;signatures&quot;</span><span class="punctuation">]</span> <span class="operator">=</span> <span class="name">signed_json_oject</span><span class="punctuation">[</span><span class="literal string double">&quot;signatures&quot;</span><span class="punctuation">]</span>
    <span class="keyword">return</span> <span class="name">event_json_object</span>
</pre>
<p>Servers can then transmit the entire event or the event with the non-essential
keys removed. If the entire event is present, receiving servers can then check
the event by computing the SHA-256 of the event, excluding the <tt class="docutils literal">hash</tt> object.
If the keys have been redacted, then the <tt class="docutils literal">hash</tt> object is included when
calculating the SHA-256 instead.</p>
<p>New hash functions can be introduced by adding additional keys to the <tt class="docutils literal">hash</tt>
object. Since the <tt class="docutils literal">hash</tt> object cannot be redacted a server shouldn't allow
too many hashes to be listed, otherwise a server might embed illict data within
the <tt class="docutils literal">hash</tt> object. For similar reasons a server shouldn't allow hash values
that are too long.</p>
<!-- TODO
[[TODO(markjh): We might want to specify a maximum number of keys for the
``hash`` and we might want to specify the maximum output size of a hash]]
[[TODO(markjh) We might want to allow the server to omit the output of well
known hash functions like SHA-256 when none of the keys have been redacted]] -->
</div>
</div>
</body>
</html>
