<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Room Version 2</title>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    padding-left: 20px;
}

</style>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

table.colwidths-auto caption {
    font-family: 'Inconsolata', monospace;
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

.section ol, .section li {
    margin: 0px 0px 0px 30px !important;
}

p.httpheaders {
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

table.colwidths-auto {
    width:100%;
    margin-top: 20px;
}

table.colwidths-auto tr td:nth-child(1) {
    width: 15%;
}

table.colwidths-auto tr td:nth-child(2) {
    width: 15%;
    font-family: 'Inconsolata', monospace;
}

table.colwidths-auto tr td:nth-child(3) {
    width: 70%;
}


/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- proposals page -------------------------------------------------------- */

#tables-of-tracked-proposals h2 {
    padding-left: 10px;
    position: -webkit-sticky;
    position: sticky;
}

/* Move sticky headers below header bar on desktop */
@media all and (min-width:980px) {
    #tables-of-tracked-proposals h2 {
        top: 52px;
    }
}

/* Sticky headers stick to the top on mobile */
@media all and (min-width:0px) and (max-width: 980px) {
    #tables-of-tracked-proposals h2 {
        top: 0px;
    }
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
    text-transform: capitalize;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}

div.admonition-example {
    background-color: #eef;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/*
*   math2html: convert LaTeX equations to HTML output.
*
*   Copyright (C) 2009,2010 Alex Fernández
*
*   Released under the terms of the `2-Clause BSD license'_, in short:
*   Copying and distribution of this file, with or without modification,
*   are permitted in any medium without royalty provided the copyright
*   notice and this notice are preserved.
*   This file is offered as-is, without any warranty.
*
* .. _2-Clause BSD license: http://www.spdx.org/licenses/BSD-2-Clause
*
*   Based on eLyXer: convert LyX source files to HTML output.
*   http://elyxer.nongnu.org/
*/
/* --end--
* CSS file for LaTeX formulas.
*/

/* Formulas */
.formula {
	text-align: center;
	font-family: "Droid Serif", "DejaVu Serif", "STIX", serif;
	margin: 1.2em 0;
}
span.formula {
	white-space: nowrap;
}
div.formula {
	padding: 0.5ex;
	margin-left: auto;
	margin-right: auto;
}

/* Basic features */
a.eqnumber {
	display: inline-block;
	float: right;
	clear: right;
	font-weight: bold;
}
span.unknown {
	color: #800000;
}
span.ignored, span.arraydef {
	display: none;
}
.formula i {
	letter-spacing: 0.1ex;
}

/* Alignment */
.align-left, .align-l {
	text-align: left;
}
.align-right, .align-r {
	text-align: right;
}
.align-center, .align-c {
	text-align: center;
}

/* Structures */
span.overline, span.bar {
	text-decoration: overline;
}
.fraction, .fullfraction {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
}
.fraction .fraction {
	font-size: 80%;
	line-height: 100%;
}
span.numerator {
	display: block;
}
span.denominator {
	display: block;
	padding: 0ex;
	border-top: thin solid;
}
sup.numerator, sup.unit {
	font-size: 70%;
	vertical-align: 80%;
}
sub.denominator, sub.unit {
	font-size: 70%;
	vertical-align: -20%;
}
span.sqrt {
	display: inline-block;
	vertical-align: middle;
	padding: 0.1ex;
}
sup.root {
	font-size: 70%;
	position: relative;
	left: 1.4ex;
}
span.radical {
	display: inline-block;
	padding: 0ex;
	font-size: 150%;
	vertical-align: top;
}
span.root {
	display: inline-block;
	border-top: thin solid;
	padding: 0ex;
	vertical-align: middle;
}
span.symbol {
	line-height: 125%;
	font-size: 125%;
}
span.bigsymbol {
	line-height: 150%;
	font-size: 150%;
}
span.largesymbol {
	font-size: 175%;
}
span.hugesymbol {
	font-size: 200%;
}
span.scripts {
	display: inline-table;
	vertical-align: middle;
}
.script {
	display: table-row;
	text-align: left;
	line-height: 150%;
}
span.limits {
	display: inline-table;
	vertical-align: middle;
}
.limit {
	display: table-row;
	line-height: 99%;
}
sup.limit, sub.limit {
	line-height: 100%;
}
span.symbolover {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 100%;
	bottom: 0.5em;
	width: 0px;
}
span.withsymbol {
	display: inline-block;
}
span.symbolunder {
	display: inline-block;
	text-align: center;
	position: relative;
	float: right;
	right: 80%;
	top: 0.3em;
	width: 0px;
}

/* Environments */
span.array, span.bracketcases, span.binomial, span.environment {
	display: inline-table;
	text-align: center;
	border-collapse: collapse;
	margin: 0em;
	vertical-align: middle;
}
span.arrayrow, span.binomrow {
	display: table-row;
	padding: 0ex;
	border: 0ex;
}
span.arraycell, span.bracket, span.case, span.binomcell, span.environmentcell {
	display: table-cell;
	padding: 0ex 0.2ex;
	line-height: 99%;
	border: 0ex;
}
/*
* CSS file for LaTeX formulas, extra stuff:
* binomials, vertical braces, stackrel, fonts and colors.
*/

/* Inline binomials */
span.binom {
	display: inline-block;
	vertical-align: middle;
	text-align: center;
	font-size: 80%;
}
span.binomstack {
	display: block;
	padding: 0em;
}

/* Over- and underbraces */
span.overbrace {
	border-top: 2pt solid;
}
span.underbrace {
	border-bottom: 2pt solid;
}

/* Stackrel */
span.stackrel {
	display: inline-block;
	text-align: center;
}
span.upstackrel {
	display: block;
	padding: 0em;
	font-size: 80%;
	line-height: 64%;
	position: relative;
	top: 0.15em;

}
span.downstackrel {
	display: block;
	vertical-align: bottom;
	padding: 0em;
}

/* Fonts */
span.mathsf, span.textsf {
	font-style: normal;
	font-family: sans-serif;
}
span.mathrm, span.textrm {
	font-style: normal;
	font-family: serif;
}
span.text, span.textnormal {
	font-style: normal;
}
span.textipa {
	color: #008080;
}
span.fraktur {
	font-family: "Lucida Blackletter", eufm10, blackletter;
}
span.blackboard {
	font-family: Blackboard, msbm10, serif;
}
span.scriptfont {
	font-family: "Monotype Corsiva", "Apple Chancery", "URW Chancery L", cursive;
	font-style: italic;
}

/* Colors */
span.colorbox {
	display: inline-block;
	padding: 5px;
}
span.fbox {
	display: inline-block;
	border: thin solid black;
	padding: 2px;
}
span.boxed, span.framebox {
	display: inline-block;
	border: thin solid black;
	padding: 5px;
}


</style>
</head>
<body>
<div class="document" id="room-version-2">
<h1 class="title">Room Version 2</h1>

<!-- Copyright 2018-2019 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>This room version builds off of <a class="reference external" href="v1.html">version 1</a> with an improved state
resolution algorithm.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#server-implementation-components" id="id1">1&nbsp;&nbsp;&nbsp;Server implementation components</a><ul class="auto-toc">
<li><a class="reference internal" href="#state-resolution" id="id2">1.1&nbsp;&nbsp;&nbsp;State resolution</a><ul class="auto-toc">
<li><a class="reference internal" href="#definitions" id="id3">1.1.1&nbsp;&nbsp;&nbsp;Definitions</a></li>
<li><a class="reference internal" href="#algorithm" id="id4">1.1.2&nbsp;&nbsp;&nbsp;Algorithm</a></li>
<li><a class="reference internal" href="#rejected-events" id="id5">1.1.3&nbsp;&nbsp;&nbsp;Rejected events</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<p><a class="anchor" id="server-implementation-components"></a></p>
<div class="section" id="server-implementation-components">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Server implementation components</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The information contained in this section is strictly for server implementors.
Applications which use the Client-Server API are generally unaffected by the
details contained here, and can safely ignore their presence.</p>
</div>
<p>Room version 2 uses the base components of <a class="reference external" href="v1.html">room version 1</a>, changing
only the state resolution algorithm.</p>
<p><a class="anchor" id="state-resolution"></a></p>
<div class="section" id="state-resolution">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;State resolution</a></h2>
<p>The room state <span class="formula"><i>S</i>’(<i>E</i>)</span> after an event <span class="formula"><i>E</i></span> is defined in terms of
the room state <span class="formula"><i>S</i>(<i>E</i>)</span> before <span class="formula"><i>E</i></span>, and depends on whether
<span class="formula"><i>E</i></span> is a state event or a message event:</p>
<ul class="simple">
<li>If <span class="formula"><i>E</i></span> is a message event, then <span class="formula"><i>S</i>’(<i>E</i>) = <i>S</i>(<i>E</i>)</span>.</li>
<li>If <span class="formula"><i>E</i></span> is a state event, then <span class="formula"><i>S</i>’(<i>E</i>)</span> is <span class="formula"><i>S</i>(<i>E</i>)</span>, except
that its entry corresponding to <span class="formula"><i>E</i></span>'s <tt class="docutils literal">event_type</tt> and <tt class="docutils literal">state_key</tt>
is replaced by <span class="formula"><i>E</i></span>'s <tt class="docutils literal">event_id</tt>.</li>
</ul>
<p>The room state <span class="formula"><i>S</i>(<i>E</i>)</span> before <span class="formula"><i>E</i></span> is the <em>resolution</em> of the set of
states <span class="formula">{<i>S</i>’(<i>E</i><sub>1</sub>), <i>S</i>’(<i>E</i><sub>2</sub>), …}</span> consisting of the states after each of
<span class="formula"><i>E</i></span>'s <tt class="docutils literal">prev_event</tt>s <span class="formula">{<i>E</i><sub>1</sub>, <i>E</i><sub>2</sub>, …}</span>, where the resolution of
a set of states is given in the algorithm below.</p>
<p><a class="anchor" id="definitions"></a></p>
<div class="section" id="definitions">
<h3><a class="toc-backref" href="#id3">1.1.1&nbsp;&nbsp;&nbsp;Definitions</a></h3>
<p>The state resolution algorithm for version 2 rooms uses the following
definitions, given the set of room states <span class="formula">{<i>S</i><sub>1</sub>, <i>S</i><sub>2</sub>, …}</span>:</p>
<dl class="docutils">
<dt>Power events</dt>
<dd>A <em>power event</em> is a state event with type <tt class="docutils literal">m.room.power_levels</tt> or
<tt class="docutils literal">m.room.join_rules</tt>, or a state event with type <tt class="docutils literal">m.room.member</tt> where the
<tt class="docutils literal">membership</tt> is <tt class="docutils literal">leave</tt> or <tt class="docutils literal">ban</tt> and the <tt class="docutils literal">sender</tt> does not match the
<tt class="docutils literal">state_key</tt>. The idea behind this is that power events are events that might
remove someone's ability to do something in the room.</dd>
<dt>Unconflicted state map and conflicted state set</dt>
<dd>The <em>unconflicted state map</em> is the state where the value of each key exists
and is the same in each state <span class="formula"><i>S</i><sub><i>i</i></sub></span>.  The <em>conflicted state set</em> is the
set of all other state events. Note that the unconflicted state map only has
one event per <tt class="docutils literal">(event_type, state_key)</tt>, whereas the conflicted state set
may have multiple events.</dd>
<dt>Auth difference</dt>
<dd>The <em>auth difference</em> is calculated by first calculating the full auth chain
for each state <span class="formula"><i>S</i><sub><i>i</i></sub></span>, that is the union of the auth chains for each
event in <span class="formula"><i>S</i><sub><i>i</i></sub></span>, and then taking every event that doesn't appear in
every auth chain. If <span class="formula"><i>C</i><sub><i>i</i></sub></span> is the full auth chain of <span class="formula"><i>S</i><sub><i>i</i></sub></span>, then
the auth difference is <span class="formula">∪<i>C</i><sub><i>i</i></sub> − ∩<i>C</i><sub><i>i</i></sub></span>.</dd>
<dt>Full conflicted set</dt>
<dd>The <em>full conflicted set</em> is the union of the conflicted state set and the
auth difference.</dd>
<dt>Reverse topological power ordering</dt>
<dd><p class="first">The <em>reverse topological power ordering</em> of a set of events is the
lexicographically smallest topological ordering based on the DAG formed by
auth events. The reverse topological power ordering is ordered from earliest
event to latest. For comparing two topological orderings to determine which
is the lexicographically smallest, the following comparison relation on
events is used: for events <span class="formula"><i>x</i></span> and <span class="formula"><i>y</i></span>, <span class="formula"><i>x</i> &lt; <i>y</i></span> if</p>
<ol class="arabic simple">
<li><span class="formula"><i>x</i></span>'s sender has <em>greater</em> power level than <span class="formula"><i>y</i></span>'s sender,
when looking at their respective <tt class="docutils literal">auth_event</tt>s; or</li>
<li>the senders have the same power level, but <span class="formula"><i>x</i></span>'s
<tt class="docutils literal">origin_server_ts</tt> is <em>less</em> than <span class="formula"><i>y</i></span>'s <tt class="docutils literal">origin_server_ts</tt>; or</li>
<li>the senders have the same power level and the events have the same
<tt class="docutils literal">origin_server_ts</tt>, but <span class="formula"><i>x</i></span>'s <tt class="docutils literal">event_id</tt> is <em>less</em> than
<span class="formula"><i>y</i></span>'s <tt class="docutils literal">event_id</tt>.</li>
</ol>
<p class="last">The reverse topological power ordering can be found by sorting the events
using Kahn's algorithm for topological sorting, and at each step selecting,
among all the candidate vertices, the smallest vertex using the above
comparison relation.</p>
</dd>
<dt>Mainline ordering</dt>
<dd><p class="first">Given an <tt class="docutils literal">m.room.power_levels</tt> event <span class="formula"><i>P</i></span>, the <em>mainline of</em> <span class="formula"><i>P</i></span>
is the list of events generated by starting with <span class="formula"><i>P</i></span> and recursively
taking the <tt class="docutils literal">m.room.power_levels</tt> events from the <tt class="docutils literal">auth_events</tt>, ordered
such that <span class="formula"><i>P</i></span> is last. Given another event <span class="formula"><i>e</i></span>, the <em>closest
mainline event to</em> <span class="formula"><i>e</i></span> is the first event encountered in the mainline
when iteratively descending through the <tt class="docutils literal">m.room.power_levels</tt> events in the
<tt class="docutils literal">auth_events</tt> starting at <span class="formula"><i>e</i></span>. If no mainline event is encountered
when iteratively descending through the <tt class="docutils literal">m.room.power_levels</tt> events, then
the closest mainline event to <span class="formula"><i>e</i></span> can be considered to be a dummy event
that is before any other event in the mainline of <span class="formula"><i>P</i></span> for the purposes
of condition 1 below.</p>
<p>The <em>mainline ordering based on</em> <span class="formula"><i>P</i></span> of a set of events is the
ordering, from smallest to largest, using the following comparison relation
on events: for events <span class="formula"><i>x</i></span> and <span class="formula"><i>y</i></span>, <span class="formula"><i>x</i> &lt; <i>y</i></span> if</p>
<ol class="last arabic simple">
<li>the closest mainline event to <span class="formula"><i>x</i></span> appears <em>before</em> the closest
mainline event to <span class="formula"><i>y</i></span>; or</li>
<li>the closest mainline events are the same, but <span class="formula"><i>x</i></span>'s
<tt class="docutils literal">origin_server_ts</tt> is <em>less</em> than <span class="formula"><i>y</i></span>'s <tt class="docutils literal">origin_server_ts</tt>; or</li>
<li>the closest mainline events are the same and the events have the same
<tt class="docutils literal">origin_server_ts</tt>, but <span class="formula"><i>x</i></span>'s <tt class="docutils literal">event_id</tt> is <em>less</em> than
<span class="formula"><i>y</i></span>'s <tt class="docutils literal">event_id</tt>.</li>
</ol>
</dd>
<dt>Iterative auth checks</dt>
<dd>The <em>iterative auth checks algorithm</em> takes as input an initial room state
and a sorted list of state events, and constructs a new room state by
iterating through the event list and applying the state event to the room
state if the state event is allowed by the <a class="reference external" href="../server_server/r0.1.1.html#authorization-rules">authorization rules</a>. If the
state event is not allowed by the authorization rules, then the event is
ignored. If a <tt class="docutils literal">(event_type, state_key)</tt> key that is required for checking
the authorization rules is not present in the state, then the appropriate
state event from the event's <tt class="docutils literal">auth_events</tt> is used if the auth event is
not rejected.</dd>
</dl>
</div>
<p><a class="anchor" id="algorithm"></a></p>
<div class="section" id="algorithm">
<h3><a class="toc-backref" href="#id4">1.1.2&nbsp;&nbsp;&nbsp;Algorithm</a></h3>
<p>The <em>resolution</em> of a set of states is obtained as follows:</p>
<ol class="arabic simple">
<li>Take all <em>power events</em> and any events in their auth chains, recursively,
that appear in the <em>full conflicted set</em> and order them by the <em>reverse
topological power ordering</em>.</li>
<li>Apply the <em>iterative auth checks algorithm</em> on the <em>unconflicted state map</em>
and the list of events from the previous step to get a partially resolved
state.</li>
<li>Take all remaining events that weren't picked in step 1 and order them by
the mainline ordering based on the power level in the partially resolved
state obtained in step 2.</li>
<li>Apply the <em>iterative auth checks algorithm</em> on the partial resolved
state and the list of events from the previous step.</li>
<li>Update the result by replacing any event with the event with the same key
from the <em>unconflicted state map</em>, if such an event exists, to get the final
resolved state.</li>
</ol>
</div>
<p><a class="anchor" id="rejected-events"></a></p>
<div class="section" id="rejected-events">
<h3><a class="toc-backref" href="#id5">1.1.3&nbsp;&nbsp;&nbsp;Rejected events</a></h3>
<p>Events that have been rejected due to failing auth based on the state at the
event (rather than based on their auth chain) are handled as usual by the
algorithm, unless otherwise specified.</p>
<p>Note that no events rejected due to failure to auth against their auth chain
should appear in the process, as they should not appear in state (the algorithm
only uses events that appear in either the state sets or in the auth chain of
the events in the state sets).</p>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p>This helps ensure that different servers' view of state is more likely to
converge, since rejection state of an event may be different. This can happen if
a third server gives an incorrect version of the state when a server joins a
room via it (either due to being faulty or malicious). Convergence of state is a
desirable property as it ensures that all users in the room have a (mostly)
consistent view of the state of the room. If the view of the state on different
servers diverges it can lead to bifurcation of the room due to e.g. servers
disagreeing on who is in the room.</p>
<p>Intuitively, using rejected events feels dangerous, however:</p>
<ol class="last arabic simple">
<li>Servers cannot arbitrarily make up state, since they still need to pass the
auth checks based on the event's auth chain (e.g. they can't grant themselves
power levels if they didn't have them before).</li>
<li>For a previously rejected event to pass auth there must be a set of state
that allows said event. A malicious server could therefore produce a
fork where it claims the state is that particular set of state, duplicate the
rejected event to point to that fork, and send the event. The
duplicated event would then pass the auth checks. Ignoring rejected events
would therefore not eliminate any potential attack vectors.</li>
</ol>
</div>
<p>Rejected auth events are deliberately excluded from use in the iterative auth
checks, as auth events aren't re-authed (although non-auth events are) during
the iterative auth checks.</p>
</div>
</div>
</div>
</div>
</body>
</html>
