<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.14: http://docutils.sourceforge.net/" />
<title>Room Version 3</title>
<style type="text/css">

pre.code .comment, code .comment { color: green }
pre.code .keyword, code .keyword { color: darkred; font-weight: bold }
pre.code .name.builtin, code .name.builtin { color: darkred; font-weight: bold }
pre.code .name.tag, code .name.tag { color: darkgreen }
pre.code .literal, code .literal { color: darkblue }
pre.code .literal.number, code .literal.number { color: blue }


/* HTTP Methods have class "name function" */
pre.code.http .name.function,  code.http .name.function { color: black; font-weight: bold }
/* HTTP Paths have class "name namespace" */
pre.code.http .name.namespace, code.http .name.namespace { color: darkgreen }
/* HTTP "HTTP" strings have class "keyword reserved" */
pre.code.http .keyword.reserved, code.http .keyword.reserved { color: black; font-weight: bold }
/* HTTP Header names have class "name attribute" */
pre.code.http .name.attribute, code.http .name.attribute { color: black; font-weight: bold }

</style>
<style type="text/css">

blockquote {
    margin: 20px 0 30px;
    padding-left: 20px;
}

</style>
<style type="text/css">

/*
 * basic.css
 * ~~~~~~~~~
 *
 * Sphinx stylesheet -- basic theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- main layout ----------------------------------------------------------- */

div.clearer {
    clear: both;
}

/* -- relbar ---------------------------------------------------------------- */

div.related {
    width: 100%;
    font-size: 90%;
}

div.related h3 {
    display: none;
}

div.related ul {
    margin: 0;
    padding: 0 0 0 10px;
    list-style: none;
}

div.related li {
    display: inline;
}

div.related li.right {
    float: right;
    margin-right: 5px;
}

/* -- sidebar --------------------------------------------------------------- */

div.sphinxsidebarwrapper {
    padding: 10px 5px 0 10px;
}

div.sphinxsidebar {
    float: left;
    width: 230px;
    margin-left: -100%;
    font-size: 90%;
}

div.sphinxsidebar ul {
    list-style: none;
}

div.sphinxsidebar ul ul,
div.sphinxsidebar ul.want-points {
    margin-left: 20px;
    list-style: square;
}

div.sphinxsidebar ul ul {
    margin-top: 0;
    margin-bottom: 0;
}

div.sphinxsidebar form {
    margin-top: 10px;
}

div.sphinxsidebar input {
    border: 1px solid #98dbcc;
    font-family: sans-serif;
    font-size: 1em;
}

img {
    border: 0;
}

/* -- search page ----------------------------------------------------------- */

ul.search {
    margin: 10px 0 0 20px;
    padding: 0;
}

ul.search li {
    padding: 5px 0 5px 20px;
    background-image: url(file.png);
    background-repeat: no-repeat;
    background-position: 0 7px;
}

ul.search li a {
    font-weight: bold;
}

ul.search li div.context {
    color: #888;
    margin: 2px 0 0 30px;
    text-align: left;
}

ul.keywordmatches li.goodmatch a {
    font-weight: bold;
}

/* -- index page ------------------------------------------------------------ */

table.contentstable {
    width: 90%;
}

table.contentstable p.biglink {
    line-height: 150%;
}

a.biglink {
    font-size: 1.3em;
}

span.linkdescr {
    font-style: italic;
    padding-top: 5px;
    font-size: 90%;
}

/* -- general index --------------------------------------------------------- */

table.indextable {
    width: 100%;
}

table.indextable td {
    text-align: left;
    vertical-align: top;
}

table.indextable dl, table.indextable dd {
    margin-top: 0;
    margin-bottom: 0;
}

table.indextable tr.pcap {
    height: 10px;
}

table.indextable tr.cap {
    margin-top: 10px;
    background-color: #f2f2f2;
}

img.toggler {
    margin-right: 3px;
    margin-top: 3px;
    cursor: pointer;
}

div.modindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

div.genindex-jumpbox {
    border-top: 1px solid #ddd;
    border-bottom: 1px solid #ddd;
    margin: 1em 0 1em 0;
    padding: 0.4em;
}

/* -- general body styles --------------------------------------------------- */

a.headerlink {
    visibility: hidden;
}

h1:hover > a.headerlink,
h2:hover > a.headerlink,
h3:hover > a.headerlink,
h4:hover > a.headerlink,
h5:hover > a.headerlink,
h6:hover > a.headerlink,
dt:hover > a.headerlink {
    visibility: visible;
}

div.document p.caption {
    text-align: inherit;
}

div.document td {
    text-align: left;
}

.field-list ul {
    padding-left: 1em;
}

.first {
    margin-top: 0 !important;
}

p.rubric {
    margin-top: 30px;
    font-weight: bold;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* -- sidebars -------------------------------------------------------------- */

div.sidebar {
    margin: 0 0 0.5em 1em;
    border: 1px solid #ddb;
    padding: 7px 7px 0 7px;
    background-color: #ffe;
    width: 40%;
    float: right;
}

p.sidebar-title {
    font-weight: bold;
}

/* -- topics ---------------------------------------------------------------- */

div.topic {
    border: 1px solid #ccc;
    padding: 7px 7px 0 7px;
    margin: 10px 0 10px 0;
}

p.topic-title {
    font-size: 1.1em;
    font-weight: bold;
    margin-top: 10px;
}

/* -- admonitions ----------------------------------------------------------- */

div.admonition {
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 7px;
}

div.admonition dt {
    font-weight: bold;
}

div.admonition dl {
    margin-bottom: 0;
}

p.admonition-title {
    margin: 0px 10px 5px 0px;
    font-weight: bold;
}

div.document p.centered {
    text-align: center;
    margin-top: 25px;
}

/* -- tables ---------------------------------------------------------------- */

table.docutils {
    border: 0;
    border-collapse: collapse;
}

table.docutils td, table.docutils th {
    padding: 1px 8px 1px 5px;
    border-top: 0;
    border-left: 0;
    border-right: 0;
    border-bottom: 1px solid #aaa;
}

table.field-list td, table.field-list th {
    border: 0 !important;
}

table.footnote td, table.footnote th {
    border: 0 !important;
}

th {
    text-align: left;
    padding-right: 5px;
}

table.citation {
    border-left: solid 1px gray;
    margin-left: 1px;
}

table.citation td {
    border-bottom: none;
}

table.colwidths-auto caption {
    font-family: 'Inconsolata', monospace;
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

.section ol, .section li {
    margin: 0px 0px 0px 30px !important;
}

p.httpheaders {
    font-weight: 800;
    font-size: 120%;
    padding: 5px;
    text-align: left;
    margin-bottom: 2px;
}

table.colwidths-auto {
    width:100%;
    margin-top: 20px;
}

table.colwidths-auto tr td:nth-child(1) {
    width: 15%;
}

table.colwidths-auto tr td:nth-child(2) {
    width: 15%;
    font-family: 'Inconsolata', monospace;
}

table.colwidths-auto tr td:nth-child(3) {
    width: 70%;
}


/* -- other body styles ----------------------------------------------------- */

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl {
    margin-bottom: 15px;
}

dd p {
    margin-top: 0px;
}

dd ul, dd table {
    margin-bottom: 10px;
}

dd {
    margin-top: 3px;
    margin-bottom: 10px;
    margin-left: 30px;
}

dt:target, .highlighted {
    background-color: #fbe54e;
}

dl.glossary dt {
    font-weight: bold;
    font-size: 1.1em;
}

.field-list ul {
    margin: 0;
    padding-left: 1em;
}

.field-list p {
    margin: 0;
}

.refcount {
    color: #060;
}

.optional {
    font-size: 1.3em;
}

.versionmodified {
    font-style: italic;
}

.system-message {
    background-color: #fda;
    padding: 5px;
    border: 3px solid red;
}

.footnote:target  {
    background-color: #ffa
}

.line-block {
    display: block;
    margin-top: 1em;
    margin-bottom: 1em;
}

.line-block .line-block {
    margin-top: 0;
    margin-bottom: 0;
    margin-left: 1.5em;
}

.guilabel, .menuselection {
    font-family: sans-serif;
}

.accelerator {
    text-decoration: underline;
}

.classifier {
    font-style: oblique;
}

/* -- proposals page -------------------------------------------------------- */

#tables-of-tracked-proposals h2 {
    padding-left: 10px;
    position: -webkit-sticky;
    position: sticky;
}

/* Move sticky headers below header bar on desktop */
@media all and (min-width:980px) {
    #tables-of-tracked-proposals h2 {
        top: 52px;
    }
}

/* Sticky headers stick to the top on mobile */
@media all and (min-width:0px) and (max-width: 980px) {
    #tables-of-tracked-proposals h2 {
        top: 0px;
    }
}

/* -- code displays --------------------------------------------------------- */

pre {
    overflow: auto;
}

td.linenos pre {
    padding: 5px 0px;
    border: 0;
    background-color: transparent;
    color: #aaa;
}

table.highlighttable {
    margin-left: 0.5em;
}

table.highlighttable td {
    padding: 0 0.5em 0 0.5em;
}

tt.descname {
    background-color: transparent;
    font-weight: bold;
    font-size: 1.2em;
}

tt.descclassname {
    background-color: transparent;
}

tt.xref, a tt {
    background-color: transparent;
    font-weight: bold;
}

h1 tt, h2 tt, h3 tt, h4 tt, h5 tt, h6 tt {
    background-color: transparent;
}

.viewcode-link {
    float: right;
}

.viewcode-back {
    float: right;
    font-family: sans-serif;
}

div.viewcode-block:target {
    margin: -1px -10px;
    padding: 0 10px;
}

/* -- math display ---------------------------------------------------------- */

img.math {
    vertical-align: middle;
}

div.document div.math p {
    text-align: center;
}

span.eqno {
    float: right;
}

/* -- printout stylesheet --------------------------------------------------- */

@media print {
    div.document,
    div.documentwrapper,
    div.bodywrapper {
        margin: 0 !important;
        width: 100%;
    }

    div.sphinxsidebar,
    div.related,
    div.footer,
    #top-link {
        display: none;
    }
}


</style>
<style type="text/css">

/*
 * nature.css_t
 * ~~~~~~~~~~~~
 *
 * Sphinx stylesheet -- nature theme.
 *
 * :copyright: Copyright 2007-2010 by the Sphinx team, see AUTHORS.
 * :license: BSD, see LICENSE for details.
 *
 */

/* -- page layout ----------------------------------------------------------- */

body {
    font-family: Arial, sans-serif;
    font-size: 100%;
    /*background-color: #111;*/
    color: #555;
    margin: 0;
    padding: 0;
}

div.documentwrapper {
    float: left;
    width: 100%;
}

div.bodywrapper {
    margin: 0 0 0 230px;
}

hr {
    border: 1px solid #B1B4B6;
}

/*
div.document {
    background-color: #eee;
}
*/

div.document {
    background-color: #ffffff;
    color: #3E4349;
    padding: 0 30px 30px 30px;
    font-size: 0.9em;
}

div.footer {
    color: #555;
    width: 100%;
    padding: 13px 0;
    text-align: center;
    font-size: 75%;
}

div.footer a {
    color: #444;
    text-decoration: underline;
}

div.related {
    background-color: #6BA81E;
    line-height: 32px;
    color: #fff;
    text-shadow: 0px 1px 0 #444;
    font-size: 0.9em;
}

div.related a {
    color: #E2F3CC;
}

div.sphinxsidebar {
    font-size: 0.75em;
    line-height: 1.5em;
}

div.sphinxsidebarwrapper{
    padding: 20px 0;
}

div.sphinxsidebar h3,
div.sphinxsidebar h4 {
    font-family: Arial, sans-serif;
    color: #222;
    font-size: 1.2em;
    font-weight: normal;
    margin: 0;
    padding: 5px 10px;
    background-color: #ddd;
    text-shadow: 1px 1px 0 white
}

div.sphinxsidebar h4{
    font-size: 1.1em;
}

div.sphinxsidebar h3 a {
    color: #444;
}


div.sphinxsidebar p {
    color: #888;
    padding: 5px 20px;
}

div.sphinxsidebar p.topless {
}

div.sphinxsidebar ul {
    margin: 10px 20px;
    padding: 0;
    color: #000;
}

div.sphinxsidebar a {
    color: #444;
}

div.sphinxsidebar input {
    border: 1px solid #ccc;
    font-family: sans-serif;
    font-size: 1em;
}

div.sphinxsidebar input[type=text]{
    margin-left: 20px;
}

/* -- body styles ----------------------------------------------------------- */

a {
    color: #005B81;
    text-decoration: none;
}

a:hover {
    color: #E32E00;
    text-decoration: underline;
}

div.document h1,
div.document h2,
div.document h3,
div.document h4,
div.document h5,
div.document h6 {
    font-family: Arial, sans-serif;
    background-color: #BED4EB;
    font-weight: normal;
    color: #212224;
    margin: 30px 0px 10px 0px;
    padding: 5px 0 5px 10px;
    text-shadow: 0px 1px 0 white
}

div.document h1 { border-top: 20px solid white; margin-top: 0; font-size: 200%; }
div.document h2 { font-size: 150%; background-color: #C8D5E3; }
div.document h3 { font-size: 120%; background-color: #D8DEE3; }
div.document h4 { font-size: 110%; background-color: #D8DEE3; }
div.document h5 { font-size: 100%; background-color: #D8DEE3; }
div.document h6 { font-size: 100%; background-color: #D8DEE3; }

a.headerlink {
    color: #c60f0f;
    font-size: 0.8em;
    padding: 0 4px 0 4px;
    text-decoration: none;
}

a.headerlink:hover {
    background-color: #c60f0f;
    color: white;
}

div.document p, div.document dd, div.document li {
    line-height: 1.5em;
}

div.admonition p.admonition-title + p {
    display: inline;
}

div.highlight{
    background-color: white;
}

div.note {
    background-color: #eee;
    border: 1px solid #ccc;
}

div.seealso {
    background-color: #ffc;
    border: 1px solid #ff6;
}

div.topic {
    background-color: #eee;
}

div.warning {
    background-color: #ffe4e4;
    border: 1px solid #f66;
}

p.admonition-title {
    display: inline;
}

p.admonition-title:after {
    content: ":";
}

pre {
    padding: 10px;
    background-color: White;
    color: #222;
    line-height: 1.2em;
    border: 1px solid #C6C9CB;
    font-size: 1.1em;
    margin: 1.5em 0 1.5em 0;
    -webkit-box-shadow: 1px 1px 1px #d8d8d8;
    -moz-box-shadow: 1px 1px 1px #d8d8d8;
}

tt {
    background-color: #ecf0f3;
    color: #222;
    /* padding: 1px 2px; */
    font-size: 1.1em;
    font-family: monospace;
}

.viewcode-back {
    font-family: Arial, sans-serif;
}

div.viewcode-block:target {
    background-color: #f4debf;
    border-top: 1px solid #ac9;
    border-bottom: 1px solid #ac9;
}

ul li dd {
	margin-top: 0;
}

ul li dl {
	margin-bottom: 0;
}

li dl dd {
	margin-bottom: 0;
}

dd ul {
	padding-left: 0;
}

li dd ul {
	margin-bottom: 0;
}

table {
    margin-top: 10px;
    margin-bottom: 10px;
    border: 0;
    border-collapse: collapse;
}

td[colspan]:not([colspan="1"]) {
    background: #eeeeee;
    text-transform: capitalize;
}

thead {
    background: #eeeeee;
}

div.admonition-rationale {
    background-color: #efe;
    border: 1px solid #ccc;
}

div.admonition-example {
    background-color: #eef;
    border: 1px solid #ccc;
}


</style>
<style type="text/css">

/* Column with header cells */
table.docutils tbody th.stub {
    background: #eeeeee;
}

</style>
</head>
<body>
<div class="document" id="room-version-3">
<h1 class="title">Room Version 3</h1>

<!-- Copyright 2018-2019 New Vector Ltd -->
<!--  -->
<!-- Licensed under the Apache License, Version 2.0 (the "License"); -->
<!-- you may not use this file except in compliance with the License. -->
<!-- You may obtain a copy of the License at -->
<!--  -->
<!-- http://www.apache.org/licenses/LICENSE-2.0 -->
<!--  -->
<!-- Unless required by applicable law or agreed to in writing, software -->
<!-- distributed under the License is distributed on an "AS IS" BASIS, -->
<!-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. -->
<!-- See the License for the specific language governing permissions and -->
<!-- limitations under the License. -->
<p>This room version builds on <a class="reference external" href="v2.html">version 2</a> with an improved event format.</p>
<!-- note:
All requirements listed in this room version specification are scoped to rooms
which actually use this room version. For example, a requirement of "all APIs must
accept the new event format" does in fact apply to all APIs, but only so much as
where the contextual room of the request is using this room version. Rooms using
other room versions should not be affected by these sweeping requirements. -->
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#client-considerations" id="id1">1&nbsp;&nbsp;&nbsp;Client considerations</a></li>
<li><a class="reference internal" href="#server-implementation-components" id="id2">2&nbsp;&nbsp;&nbsp;Server implementation components</a><ul class="auto-toc">
<li><a class="reference internal" href="#event-ids" id="id3">2.1&nbsp;&nbsp;&nbsp;Event IDs</a><ul class="auto-toc">
<li><a class="reference internal" href="#persistent-data-unit-schema" id="id4">2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">Persistent Data Unit</tt> schema</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changes-to-apis" id="id5">2.2&nbsp;&nbsp;&nbsp;Changes to APIs</a></li>
<li><a class="reference internal" href="#authorization-rules-for-events" id="id6">2.3&nbsp;&nbsp;&nbsp;Authorization rules for events</a></li>
</ul>
</li>
</ul>
</div>
<p><a class="anchor" id="client-considerations"></a></p>
<div class="section" id="client-considerations">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;Client considerations</a></h1>
<p>This room version changes the format for event IDs sent to clients. Clients should be
aware that these event IDs may contain slashes and other potentially problematic
characters. Clients should be treating event IDs as opaque identifiers and should not
be attempting to parse them into a usable form, just like with other room versions.</p>
<p>Clients should expect to see event IDs changed from the format of <tt class="docutils literal">$randomstring:example.org</tt>
to something like <tt class="docutils literal">$acR1l0raoZnm60CBwAVgqbZqoO/mYU81xysh1u7XcJk</tt> (note the lack of
domain and the potentially problematic slash).</p>
</div>
<p><a class="anchor" id="server-implementation-components"></a></p>
<div class="section" id="server-implementation-components">
<h1><a class="toc-backref" href="#id2">2&nbsp;&nbsp;&nbsp;Server implementation components</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The information contained in this section is strictly for server implementors.
Applications which use the Client-Server API are generally unaffected by the
intricacies contained here. The section above regarding client considerations
is the resource that Client-Server API use cases should reference.</p>
</div>
<p>Room version 3 uses the state resolution algorithm defined in <a class="reference external" href="v2.html">room version 2</a>,
and the event format defined here.</p>
<p><a class="anchor" id="event-ids"></a></p>
<div class="section" id="event-ids">
<h2><a class="toc-backref" href="#id3">2.1&nbsp;&nbsp;&nbsp;Event IDs</a></h2>
<div class="admonition admonition-rationale">
<p class="first admonition-title">Rationale</p>
<p class="last">In other room versions (namely version 1 and 2) the event ID is a distinct field
from the remainder of the event, which must be tracked as such. This leads to
complications where servers receive multiple events with the same ID in either the
same or different rooms where the server cannot easily keep track of which event it
should be using. By removing the use of a dedicated event ID, servers are required
to track the hashes on an event to determine its ID.</p>
</div>
<p>The event ID is the <a class="reference external" href="../server_server/unstable.html#reference-hashes">reference hash</a> of the event encoded using <a class="reference external" href="../appendices.html#unpadded-base64">Unpadded Base64</a>,
prefixed with <tt class="docutils literal">$</tt>. A resulting event ID using this approach should look similar to
<tt class="docutils literal">$CD66HAED5npg6074c6pDtLKalHjVfYb2q4Q3LZgrW6o</tt>.</p>
<p>Event IDs should not be sent over federation to servers when the room uses
this room version. On the receiving end of an event, the server should compute
the relevant event ID for itself.</p>
<p>Additionally, the <tt class="docutils literal">auth_events</tt> and <tt class="docutils literal">prev_events</tt> have had a format change
compared to other room versions to make it easier to handle. Instead of a tuple
of values, they are now plain lists of events.</p>
<p><a class="anchor" id="persistent-data-unit-schema"></a></p>
<div class="section" id="persistent-data-unit-schema">
<h3><a class="toc-backref" href="#id4">2.1.1&nbsp;&nbsp;&nbsp;<tt class="docutils literal">Persistent Data Unit</tt> schema</a></h3>
<p>A persistent data unit (event) for room version 3 and beyond.</p>
<p><tt class="docutils literal">Persistent Data Unit</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>room_id</td>
<td>string</td>
<td><strong>Required.</strong> Room identifier.</td>
</tr>
<tr><td>sender</td>
<td>string</td>
<td><strong>Required.</strong> The ID of the user sending the
event.</td>
</tr>
<tr><td>origin</td>
<td>string</td>
<td><strong>Required.</strong> The <tt class="docutils literal">server_name</tt> of the
homeserver that created this event.</td>
</tr>
<tr><td>origin_server_ts</td>
<td>integer</td>
<td><strong>Required.</strong> Timestamp in milliseconds on origin
homeserver when this event was created.</td>
</tr>
<tr><td>type</td>
<td>string</td>
<td><strong>Required.</strong> Event type</td>
</tr>
<tr><td>state_key</td>
<td>string</td>
<td>If this key is present, the event is a state
event, and it will replace previous events with
the same <tt class="docutils literal">type</tt> and <tt class="docutils literal">state_key</tt> in the room
state.</td>
</tr>
<tr><td>content</td>
<td>object</td>
<td><strong>Required.</strong> The content of the event.</td>
</tr>
<tr><td>prev_events</td>
<td>[string]</td>
<td><p class="first"><strong>Required.</strong> Event IDs for the most recent events
in the room that the homeserver was aware of when
it made this event.</p>
<p class="last">Must contain less than or equal to 20 events.</p>
</td>
</tr>
<tr><td>depth</td>
<td>integer</td>
<td><strong>Required.</strong> The maximum depth of the
<tt class="docutils literal">prev_events</tt>, plus one. Must be less than the
maximum value for an integer (2^63 - 1). If the
room's depth is already at the limit, the depth
must be set to the limit.</td>
</tr>
<tr><td>auth_events</td>
<td>[string]</td>
<td><p class="first"><strong>Required.</strong> Event IDs for the authorization
events that would allow this event to be in the
room.</p>
<p class="last">Must contain less than or equal to 10 events. Note
that if the relevant auth event selection rules
are used, this restriction should never be
encountered.</p>
</td>
</tr>
<tr><td>redacts</td>
<td>string</td>
<td>For redaction events, the ID of the event being
redacted.</td>
</tr>
<tr><td>unsigned</td>
<td>Example Unsigned Data</td>
<td>Additional data added by the origin server but not
covered by the <tt class="docutils literal">signatures</tt>. More keys than
those defined here may be used.</td>
</tr>
<tr><td>hashes</td>
<td>Event Hash</td>
<td><strong>Required.</strong> Content hashes of the PDU, following
the algorithm specified in <a class="reference external" href="../server_server/unstable.html#signing-events">Signing Events</a>.</td>
</tr>
<tr><td>signatures</td>
<td>{string: {string: string}}</td>
<td><strong>Required.</strong> Signatures for the PDU, following
the algorithm specified in <a class="reference external" href="../server_server/unstable.html#signing-events">Signing Events</a>.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Example Unsigned Data</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>age</td>
<td>integer</td>
<td>The number of milliseconds that have passed since
this message was sent.</td>
</tr>
<tr><td>replaces_state</td>
<td>string</td>
<td>The event ID of the state event this event
replaces.</td>
</tr>
<tr><td>prev_sender</td>
<td>string</td>
<td>The sender of the replaced state event.</td>
</tr>
<tr><td>prev_content</td>
<td>object</td>
<td>The content of the replaced state event.</td>
</tr>
<tr><td>redacted_because</td>
<td>string</td>
<td>A reason for why the event was redacted.</td>
</tr>
</tbody>
</table>
<p><tt class="docutils literal">Event Hash</tt></p>
<table border="1" class="colwidths-auto docutils">
<thead valign="bottom">
<tr><th class="head">Parameter</th>
<th class="head">Type</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>sha256</td>
<td>string</td>
<td><strong>Required.</strong> The hash.</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<pre class="code json literal-block">
<span class="punctuation">{</span>
    <span class="name tag">&quot;auth_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;$base64EncodedHash&quot;</span><span class="punctuation">,</span>
        <span class="literal string double">&quot;$AnotherEvent&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;content&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;value&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;depth&quot;</span><span class="punctuation">:</span> <span class="literal number integer">12</span><span class="punctuation">,</span>
    <span class="name tag">&quot;hashes&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;sha256&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;ThisHashCoversAllFieldsInCaseThisIsRedacted&quot;</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;origin&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;origin_server_ts&quot;</span><span class="punctuation">:</span> <span class="literal number integer">1234567890</span><span class="punctuation">,</span>
    <span class="name tag">&quot;prev_events&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span>
        <span class="literal string double">&quot;$base64EncodedHash&quot;</span><span class="punctuation">,</span>
        <span class="literal string double">&quot;$AnotherEvent&quot;</span>
    <span class="punctuation">],</span>
    <span class="name tag">&quot;redacts&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;$def/456+oldevent&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;room_id&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;!abc123:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;sender&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;&#64;someone:matrix.org&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;signatures&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;example.com&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
            <span class="name tag">&quot;ed25519:key_version:&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;86BytesOfSignatureOfTheRedactedEvent&quot;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">},</span>
    <span class="name tag">&quot;state_key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;my_key&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;type&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;m.room.message&quot;</span><span class="punctuation">,</span>
    <span class="name tag">&quot;unsigned&quot;</span><span class="punctuation">:</span> <span class="punctuation">{</span>
        <span class="name tag">&quot;key&quot;</span><span class="punctuation">:</span> <span class="literal string double">&quot;value&quot;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</pre>
</div>
</div>
<p><a class="anchor" id="changes-to-apis"></a></p>
<div class="section" id="changes-to-apis">
<h2><a class="toc-backref" href="#id5">2.2&nbsp;&nbsp;&nbsp;Changes to APIs</a></h2>
<p>Due to the event ID being removed from the event, some APIs need to change. All
APIs which currently accept an event ID must do so with the new format. Servers
must append the calculated event ID to all events sent to clients where an event
ID would normally be expected.</p>
<p>Because the format of events has changed, servers must be aware of the room version
where the event resides so that the server may parse and handle the event. The
federation API has taken this concern into consideration by ensuring that servers
are aware of (or can find) the room version during a request.</p>
</div>
<p><a class="anchor" id="authorization-rules-for-events"></a></p>
<div class="section" id="authorization-rules-for-events">
<h2><a class="toc-backref" href="#id6">2.3&nbsp;&nbsp;&nbsp;Authorization rules for events</a></h2>
<p>The authorization rules for a given event have changed in this room version due
to the change in event format:</p>
<ul class="simple">
<li>The event no longer needs to be signed by the domain of the event ID (as there
is no domain in the event ID), but still needs to be signed by the sender's
domain.</li>
<li>In past room versions, redactions were only permitted to enter the DAG if the
sender's domain matched the domain in the event ID being redacted, or the sender
had appropriate permissions per the power levels. Due to servers now not being
able to determine where an event came from during event authorization, redaction
events are always accepted (provided the event is allowed by <tt class="docutils literal">events</tt> and
<tt class="docutils literal">events_default</tt> in the power levels). However, servers should not apply or send
redactions to clients until both the redaction event and original event have been
seen, and are valid. Servers should only apply redactions to events where the
sender's domains match, or the sender of the redaction has the appropriate
permissions per the power levels.</li>
</ul>
<p>The remaining rules are the same as <a class="reference external" href="v1.html#authorization-rules">room version 1</a>.</p>
</div>
</div>
</div>
</body>
</html>
